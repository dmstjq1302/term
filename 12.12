import tkinter as tk
from tkinter import messagebox, scrolledtext, ttk
import requests
from bs4 import BeautifulSoup
import webbrowser
import threading
import math
from PIL import Image, ImageTk
from datetime import datetime, timedelta
import matplotlib

matplotlib.rcParams['font.family'] = 'Malgun Gothic'
matplotlib.use("TkAgg")
from matplotlib.figure import Figure
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import matplotlib.dates as mdates
from matplotlib.ticker import MaxNLocator

COLOR_PRIMARY = "#0078D7"
COLOR_PRIMARY_DARK = "#005A9E"
COLOR_BG = "#F0F2F5"
COLOR_CARD = "#FFFFFF"
COLOR_TEXT_MAIN = "#333333"
COLOR_TEXT_SUB = "#757575"

class HoverButton(tk.Button):
    def __init__(self, master, **kw):
        tk.Button.__init__(self, master=master, **kw)
        self.defaultBackground = self["background"]
        self.bind("<Enter>", self.on_enter)
        self.bind("<Leave>", self.on_leave)

    def on_enter(self, e):
        if self['state'] == 'normal':
            self['background'] = COLOR_PRIMARY_DARK

    def on_leave(self, e):
        self['background'] = self.defaultBackground

def create_card(parent, padx=0, pady=0):
    card = tk.Frame(parent, bg=COLOR_CARD, highlightbackground="#E0E0E0", highlightthickness=1, bd=0)
    card.pack(fill="both", expand=True, padx=padx, pady=pady)
    return card

def format_korean_number(number_str, symbol):
    try:
        if not number_str: return ""
        clean_str = number_str.replace(',', '')
        val = float(clean_str)
        sign = "-" if val < 0 else ""
        abs_val = abs(val)
        int_part = int(abs_val)
        decimal_part = ""
        if '.' in clean_str:
            decimal_part = "." + clean_str.split('.')[1][:2]
        if int_part == 0:
            return f"{sign}0{decimal_part} {symbol}"
        units = ["", "ë§Œ", "ì–µ", "ì¡°", "ê²½", "í•´"]
        parts = []
        temp = int_part
        unit_idx = 0
        while temp > 0:
            rem = temp % 10000
            if rem > 0:
                parts.append(f"{rem:,}{units[unit_idx]}")
            temp //= 10000
            unit_idx += 1
        parts.reverse()
        result_str = f"{sign}{' '.join(parts)}{decimal_part} {symbol}"
        return result_str
    except:
        return ""

def check_alerts():
    if not exchange_rates: return
    triggered_alerts = []
    for alert in list(user_alerts):
        try:
            current_rate = 1 / exchange_rates.get(alert['code'], 0)
            if current_rate == 0: continue
            condition_met = False
            if alert['op'] == '>' and current_rate > alert['value']:
                condition_met = True
            elif alert['op'] == '<' and current_rate < alert['value']:
                condition_met = True
            if condition_met:
                msg = f"ğŸ”” í™˜ìœ¨ ì•Œë¦¼!\n\n{alert['code']} í™˜ìœ¨ì´ {alert['value']:,.0f}ì› {alert['op']} ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.\ní˜„ì¬: {current_rate:,.2f}ì›"
                messagebox.showinfo("í™˜ìœ¨ ë³€ë™ ì•Œë¦¼", msg)
                triggered_alerts.append(alert)
        except Exception as e:
            print(f"ì•Œë¦¼ ì˜¤ë¥˜: {e}")
    for alert in triggered_alerts:
        if alert in user_alerts: user_alerts.remove(alert)
    if exchange_page.winfo_viewable(): update_alert_list_ui()

def add_alert():
    code = alert_currency_var.get();
    op = alert_op_var.get();
    value_str = alert_value_entry.get()
    try:
        value = float(value_str)
        if value <= 0: raise ValueError
    except ValueError:
        messagebox.showwarning("ì…ë ¥ ì˜¤ë¥˜", "ëª©í‘œ í™˜ìœ¨ì€ 0ë³´ë‹¤ í° ìˆ«ìë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."); return
    new_alert = {'code': code, 'op': op, 'value': value}
    user_alerts.append(new_alert)
    alert_value_entry.delete(0, tk.END)
    update_alert_list_ui()

def remove_alert(alert_to_remove):
    global user_alerts;
    user_alerts = [alert for alert in user_alerts if alert != alert_to_remove]
    update_alert_list_ui()

def update_alert_list_ui():
    if 'alert_list_inner_frame' in globals():
        for widget in alert_list_inner_frame.winfo_children(): widget.destroy()
        if not user_alerts:
            tk.Label(alert_list_inner_frame, text="ì„¤ì •ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.", font=("ë§‘ì€ ê³ ë”•", 11), bg=COLOR_CARD, fg="#999").pack(
                pady=20)
        else:
            for alert in user_alerts:
                alert_frame = tk.Frame(alert_list_inner_frame, bg="#F9F9F9", highlightbackground="#EEE",
                                       highlightthickness=1)
                op_char = "ì´ìƒ" if alert['op'] == '>' else "ì´í•˜"
                alert_text = f"{alert['code']}  {alert['value']:,.0f}ì› {op_char}"
                tk.Label(alert_frame, text=alert_text, font=("ë§‘ì€ ê³ ë”•", 11, "bold"), bg="#F9F9F9",
                         fg=COLOR_TEXT_MAIN).pack(side="left", padx=10, pady=8)
                HoverButton(alert_frame, text="ì‚­ì œ", font=("ë§‘ì€ ê³ ë”•", 9), fg="white", bg="#FF3B30",
                            activebackground="#D32F2F", relief="flat",
                            command=lambda a=alert: remove_alert(a)).pack(side="right", padx=10)
                alert_frame.pack(fill="x", pady=3, padx=5)

def get_gemini_response(system_prompt, user_prompt):
    api_key = ""

    if not api_key or "ì—¬ê¸°ì—" in api_key: return "ì˜¤ë¥˜: API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
    api_url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key={api_key}"
    payload = {"contents": [{"parts": [{"text": user_prompt}]}],
               "systemInstruction": {"parts": [{"text": system_prompt}]}}
    try:
        response = requests.post(api_url, json=payload, headers={'Content-Type': 'application/json'}, timeout=30)
        if response.status_code == 429: return "ì‚¬ìš©ëŸ‰ ì´ˆê³¼ (ì ì‹œ ëŒ€ê¸°)"
        response.raise_for_status();
        result = response.json()
        return result['candidates'][0]['content']['parts'][0]['text']
    except Exception as e:
        return f"ì˜¤ë¥˜: {e}"

def get_ai_summary(headlines):
    system_prompt = "ë‹¹ì‹ ì€ ì™¸í™˜ ì‹œì¥ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ë‰´ìŠ¤ í—¤ë“œë¼ì¸ì„ ë°”íƒ•ìœ¼ë¡œ ì›í™”(KRW) í™˜ìœ¨ ì‹œì¥ì˜ ì£¼ìš” ì´ìŠˆë¥¼ í•œêµ­ì–´ë¡œ 3ì¤„ ì´ë‚´ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”."
    headlines_text = "\n".join([f"- {h['title']}" for h in headlines])
    user_prompt = f"ìµœì‹  í™˜ìœ¨ ë‰´ìŠ¤:\n{headlines_text}\n\nìœ„ ë‚´ìš©ì„ ìš”ì•½í•´ ì£¼ì„¸ìš”."
    return get_gemini_response(system_prompt, user_prompt)

def update_ai_summary_thread(headlines):
    try:
        summary_text = get_ai_summary(headlines)
        if 'ai_summary_label' in globals(): window.after(0, lambda: ai_summary_label.config(text=summary_text))
    except Exception as e:
        print(f"AI ìš”ì•½ ì˜¤ë¥˜: {e}")

def get_ai_prediction_with_score(target_code, headlines):
    target_name = currency_data.get(target_code, {}).get('name', target_code)
    system_prompt = (f"ë‹¹ì‹ ì€ {target_name}({target_code}) í™˜ìœ¨ ì˜ˆì¸¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. "
                     f"ë‰´ìŠ¤ í—¤ë“œë¼ì¸ì„ ë¶„ì„í•˜ì—¬ í–¥í›„ ì¼ì£¼ì¼ê°„ì˜ ì¶”ì„¸ë¥¼ ì˜ˆì¸¡í•˜ì„¸ìš”. "
                     "ë°˜ë“œì‹œ ë‹¤ìŒ í˜•ì‹ì„ ì§€ì¼œ ë‹µë³€í•˜ì„¸ìš”:\n"
                     "1. ì˜ˆì¸¡: [ìƒìŠ¹ / í•˜ë½ / ë³´í•©] ì¤‘ íƒ1\n"
                     "2. ë¶„ì„: 3ë¬¸ì¥ ë‚´ì™¸ ì„¤ëª…\n"
                     "3. ì¡°ì–¸: í•œ ì¤„ íˆ¬ì ì¡°ì–¸\n"
                     "4. SCORE: 0~100 ì‚¬ì´ì˜ ì •ìˆ˜ (0=í­ë½ì˜ˆìƒ, 50=ë³€ë™ì—†ìŒ, 100=í­ë“±ì˜ˆìƒ). "
                     "ë§ˆì§€ë§‰ ì¤„ì€ ë°˜ë“œì‹œ 'SCORE: 75' ì²˜ëŸ¼ ì ìˆ˜ë§Œ ì ìœ¼ì„¸ìš”.")
    headlines_text = "\n".join([f"- {h['title']}" for h in headlines]) or "(ë‰´ìŠ¤ ì—†ìŒ)"
    user_prompt = f"ë¶„ì„ ëŒ€ìƒ: {target_name} {target_code}\nì°¸ê³  ë‰´ìŠ¤:\n{headlines_text}\n\ní™˜ìœ¨ ì¶”ì„¸ë¥¼ ì˜ˆì¸¡í•´ ì£¼ì„¸ìš”."
    return get_gemini_response(system_prompt, user_prompt)

def run_prediction_thread():
    target_code = prediction_currency_var.get()
    if not target_code: return
    predict_button.config(state=tk.DISABLED, text="ë¶„ì„ ì¤‘...", bg="#BDBDBD")
    prediction_result_text.config(state=tk.NORMAL);
    prediction_result_text.delete("1.0", tk.END)
    prediction_result_text.insert(tk.END, f"AIê°€ {target_code} ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...\n\n(ê³„ê¸°íŒì„ ì¤€ë¹„í•˜ëŠ” ì¤‘...)")
    prediction_result_text.config(state=tk.DISABLED)
    headlines, _ = get_news_headlines(current_news_page)
    full_text = get_ai_prediction_with_score(target_code, headlines)
    score = 50;
    clean_text = full_text
    try:
        lines = full_text.strip().split('\n');
        last_line = lines[-1].strip()
        if "SCORE:" in last_line: score = int(float(last_line.split("SCORE:")[1].strip())); clean_text = "\n".join(
            lines[:-1]).strip()
    except:
        pass
    window.after(0, lambda: update_prediction_ui(clean_text, score))

def update_prediction_ui(result_text, score):
    prediction_result_text.config(state=tk.NORMAL);
    prediction_result_text.delete("1.0", tk.END)
    prediction_result_text.insert(tk.END, result_text);
    prediction_result_text.config(state=tk.DISABLED)
    draw_gauge(gauge_canvas, score);
    predict_button.config(state=tk.NORMAL, text="AI ì˜ˆì¸¡ ì‹¤í–‰", bg=COLOR_PRIMARY)

def get_naver_exchange_rate(code):
    try:
        url = "https://finance.naver.com/marketindex/";
        response = requests.get(url, timeout=5);
        soup = BeautifulSoup(response.text, "html.parser")
        if code == 'USD':
            return float(soup.select_one("#exchangeList > li.on > a.head.usd > div > span.value").text.replace(',', ''))
        elif code == 'JPY':
            return float(soup.select_one("#exchangeList > li > a.head.jpy > div > span.value").text.replace(',', ''))
        elif code == 'EUR':
            return float(soup.select_one("#exchangeList > li > a.head.eur > div > span.value").text.replace(',', ''))
        return 1 / exchange_rates.get(code, 0.001)
    except:
        return 1 / exchange_rates.get(code, 0.001)

def calculate_fees_and_recommend():
    code = fee_currency_var.get()
    try:
        krw_amount = float(fee_amount_entry.get().replace(',', ''))
    except ValueError:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return
    base_rate = get_naver_exchange_rate(code);
    spread_rate = 0.0175 if code in ['USD', 'JPY', 'EUR'] else 0.035
    calc = lambda r, s, p: krw_amount / (r + (r * s * (1 - p)))
    app = calc(base_rate, spread_rate, 0.90);
    bank = calc(base_rate, spread_rate, 0.50);
    airport = calc(base_rate, 0.04, 0.0)
    for item in fee_tree.get_children(): fee_tree.delete(item)

    fee_tree.insert("", "end", values=("ğŸ“± ìŠ¤ë§ˆíŠ¸í° ì•± (90%)", f"{app:,.2f} {code}", "ğŸ‘‘ ìµœëŒ€ ìˆ˜ë ¹ (ì¶”ì²œ)"), tags=('recommend',))
    fee_tree.insert("", "end", values=("ğŸ¦ ì€í–‰ ì°½êµ¬ (50%)", f"{bank:,.2f} {code}", f"-{app - bank:,.2f} ì†í•´"))
    fee_tree.insert("", "end", values=("âœˆï¸ ì¸ì²œê³µí•­ (0%)", f"{airport:,.2f} {code}", f"-{app - airport:,.2f} ì†í•´"))

    for w in fee_ai_card_container.winfo_children(): w.destroy()
    tk.Label(fee_ai_card_container, text="AIê°€ ê¸ˆìœµ í˜œíƒì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ìƒì„¸ ê¿€íŒ ì‘ì„± ì¤‘)", bg="white",
             font=("ë§‘ì€ ê³ ë”•", 12)).pack(pady=20)

    saved_krw = (app - airport) * base_rate
    threading.Thread(target=run_fee_recommendation_ai, args=(code, saved_krw), daemon=True).start()

def run_fee_recommendation_ai(code, saved_krw):
    sys = "ë‹¹ì‹ ì€ ì•„ì£¼ ì¹œì ˆí•˜ê³  ê¼¼ê¼¼í•œ ê¸ˆìœµ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì´ˆë³´ìë„ ì‰½ê²Œ ë”°ë¼ í•  ìˆ˜ ìˆë„ë¡ ì„¤ëª…í•´ì£¼ì„¸ìš”."
    usr = (f"ì‚¬ìš©ìê°€ {saved_krw:,.0f}ì›ì„ ì ˆì•½í–ˆìŠµë‹ˆë‹¤. ëŒ€ìƒ í†µí™”: {code}.\n"
           "ë‹¤ìŒ 3ê°€ì§€ í•­ëª©ìœ¼ë¡œ ë‹µë³€í•˜ë˜, íŠ¹íˆ 'ADVICE' í•­ëª©ì€ ì´ˆë³´ìë¥¼ ìœ„í•´ ì•„ì£¼ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”:\n\n"
           "KEYWORD: [3ë‹¨ì–´ í•µì‹¬ ìš”ì•½]\n"
           "ADVICE: [ì¤‘ìš”] ë‹¨ìˆœíˆ 'ì•±ì„ ì“°ì„¸ìš”'ë¼ê³  í•˜ì§€ ë§ê³ , 'í† ìŠ¤ ì•±ì˜ OO ë©”ë‰´ë¥¼ ëˆ„ë¥´ì„¸ìš”' ë˜ëŠ” 'ì‹ í•œ ì  ì•±ì—ì„œ 90% ìš°ëŒ€ ì¿ í°ì„ ë°›ìœ¼ì„¸ìš”', "
           "'íŠ¸ë˜ë¸”ë¡œê·¸ ì¹´ë“œë¥¼ ë§Œë“¤ë©´ ìˆ˜ìˆ˜ë£Œê°€ 0ì›ì…ë‹ˆë‹¤' ì²˜ëŸ¼ êµ¬ì²´ì ì¸ ì‹¤í–‰ ë°©ë²•ê³¼ í˜œíƒì„ 2~3ë¬¸ì¥ìœ¼ë¡œ ê¸¸ê³  ìì„¸í•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.\n"
           "TIP: [í˜„ì§€ì—ì„œ ë°”ë¡œ ì¨ë¨¹ì„ ìˆ˜ ìˆëŠ” ì•Œì§œë°°ê¸° ì‚¬ìš©ì²˜ 1ë¬¸ì¥]")
    resp = get_gemini_response(sys, usr)
    window.after(0, lambda: update_fee_ai_ui_cards(saved_krw, resp))

def update_fee_ai_ui_cards(saved_krw, ai_text):
    for w in fee_ai_card_container.winfo_children(): w.destroy()

    keyword = "ìŠ¤ë§ˆíŠ¸í•œ í™˜ì „ ì„±ê³µ";
    advice = "í† ìŠ¤ë±…í¬ ì™¸í™”í†µì¥ì„ ê°œì„¤í•˜ë©´ í™˜ì „ ìˆ˜ìˆ˜ë£Œê°€ í‰ìƒ ë¬´ë£Œì…ë‹ˆë‹¤. í˜¹ì€ í•˜ë‚˜ íŠ¸ë˜ë¸”ë¡œê·¸ ì¹´ë“œë¥¼ ë¯¸ë¦¬ ë°œê¸‰ë°›ì•„ í˜„ì§€ ATM ì¶œê¸ˆ ìˆ˜ìˆ˜ë£Œ ë©´ì œ í˜œíƒì„ ëˆ„ë ¤ë³´ì„¸ìš”.";
    tip = "ë‚¨ì€ ì”ëˆì€ ì—¬í–‰ í›„ ì¬í™˜ì „ ìˆ˜ìˆ˜ë£Œê°€ ì—†ëŠ” ì„œë¹„ìŠ¤ë¡œ ì²˜ë¦¬í•˜ì„¸ìš”!"

    try:
        for line in ai_text.split('\n'):
            if line.startswith("KEYWORD:"):
                keyword = line.replace("KEYWORD:", "").strip()
            elif line.startswith("ADVICE:"):
                advice = line.replace("ADVICE:", "").strip()
            elif line.startswith("TIP:"):
                tip = line.replace("TIP:", "").strip()
    except:
        pass

    c1 = tk.Frame(fee_ai_card_container, bg="#E3F2FD", padx=15, pady=15, relief="groove", bd=1)
    c1.pack(side="left", fill="both", expand=False, padx=(0, 15))
    tk.Label(c1, text="ğŸ’° ì ˆì•½ ì˜ˆìƒ ê¸ˆì•¡", bg="#E3F2FD", fg="#1565C0", font=("ë§‘ì€ ê³ ë”•", 11, "bold")).pack(anchor="w")
    tk.Label(c1, text=f"{saved_krw:,.0f}ì›", bg="#E3F2FD", fg="#0D47A1", font=("ë§‘ì€ ê³ ë”•", 22, "bold")).pack(
        anchor="center", pady=10)
    tk.Label(c1, text="(ê³µí•­ í™˜ì „ ëŒ€ë¹„)", bg="#E3F2FD", fg="#555", font=("ë§‘ì€ ê³ ë”•", 9)).pack(anchor="e")

    c2 = tk.Frame(fee_ai_card_container, bg="#FFF3E0", padx=15, pady=15, relief="groove", bd=1)
    c2.pack(side="left", fill="both", expand=True, padx=(0, 15))
    tk.Label(c2, text=f"ğŸ† {keyword}", bg="#FFF3E0", fg="#E65100", font=("ë§‘ì€ ê³ ë”•", 12, "bold")).pack(anchor="w",
                                                                                                   pady=(0, 5))
    tk.Label(c2, text=advice, bg="#FFF3E0", fg="#333", font=("ë§‘ì€ ê³ ë”•", 11), justify="left", wraplength=450).pack(
        anchor="w")

    c3 = tk.Frame(fee_ai_card_container, bg="#F1F8E9", padx=15, pady=15, relief="groove", bd=1)
    c3.pack(side="left", fill="both", expand=True)
    tk.Label(c3, text="ğŸ’¡ ì „ë¬¸ê°€ TIP", bg="#F1F8E9", fg="#2E7D32", font=("ë§‘ì€ ê³ ë”•", 12, "bold")).pack(anchor="w", pady=(0, 5))
    tk.Label(c3, text=tip, bg="#F1F8E9", fg="#33691E", font=("ë§‘ì€ ê³ ë”•", 11), justify="left", wraplength=300).pack(
        anchor="w")

def draw_gauge(canvas, score):
    canvas.config(height=220);
    canvas.delete("all")
    w = 300
    h = 220
    cx = w / 2
    cy = 160
    radius = 100
    arc_width = 30

    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius,
                      start=120, extent=60, outline="#0078D7", width=arc_width, style="arc")

    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius,
                      start=60, extent=60, outline="#9E9E9E", width=arc_width, style="arc")

    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius,
                      start=0, extent=60, outline="#FF3B30", width=arc_width, style="arc")

    label_r = radius + 30
    canvas.create_text(cx + label_r * math.cos(math.radians(150)),
                       cy - label_r * math.sin(math.radians(150)),
                       text="í•˜ë½", font=("ë§‘ì€ ê³ ë”•", 11, "bold"), fill="#0078D7")
    canvas.create_text(cx, cy - label_r - 5,
                       text="ì¤‘ë¦½", font=("ë§‘ì€ ê³ ë”•", 11, "bold"), fill="#757575")
    canvas.create_text(cx + label_r * math.cos(math.radians(30)),
                       cy - label_r * math.sin(math.radians(30)),
                       text="ìƒìŠ¹", font=("ë§‘ì€ ê³ ë”•", 11, "bold"), fill="#FF3B30")

    angle = 180 - (score * 1.8)
    rad = math.radians(angle)
    needle_len = radius - 10

    canvas.create_line(cx, cy, cx + needle_len * math.cos(rad), cy - needle_len * math.sin(rad),
                       width=3, fill="#333333", capstyle="round")
    canvas.create_oval(cx - 6, cy - 6, cx + 6, cy + 6, fill="#333333", outline="")

    col = "#FF3B30" if score > 60 else "#0078D7" if score < 40 else "#757575"
    canvas.create_text(cx, cy + 30, text=f"ì‹¬ë¦¬ ì§€ìˆ˜: {score}", font=("ë§‘ì€ ê³ ë”•", 16, "bold"), fill=col)

def get_news_headlines(page_num=1):
    try:
        url = f"https://www.kita.net/cmmrcInfo/ehgtNews/ehgtNewsList.do?pageIndex={page_num}"
        resp = requests.get(url, timeout=10);
        soup = BeautifulSoup(resp.text, "html.parser")
        cnt = 0;
        summary = soup.find("div", class_="bbs-summary")
        if summary: cnt = int(summary.find("strong").text.replace(',', ''))
        items = [];
        ul = soup.find("ul", class_="board-list")
        if ul:
            for li in ul.find_all("li"):
                date = li.find("div", class_="info").find("span", class_="date").text.strip()
                a = li.find("div", class_="subject").find("a");
                title = a.text.strip()
                p = a['onclick'].split("'");
                link = f"https://www.kita.net/cmmrcInfo/ehgtNews/ehgtNewsDetail.do?classification={p[1]}&no={p[3]}"
                items.append({'title': title, 'link': link, 'date': date})
        return items[:15], cnt
    except:
        return [], 0

def open_news_link(url): webbrowser.open(url, new=2)

def on_news_enter(e, l): l.config(font=("ë§‘ì€ ê³ ë”•", 13, "bold"), fg=COLOR_PRIMARY)

def on_news_leave(e, l): l.config(font=("ë§‘ì€ ê³ ë”•", 13), fg=COLOR_TEXT_MAIN)

def populate_focus_page(page_num=1):
    for w in focus_scrollable_frame.winfo_children(): w.destroy()
    global current_news_page, total_news_pages;
    current_news_page = page_num
    if page_num == 1: ai_summary_label.config(text="AIê°€ ë‰´ìŠ¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...")
    news, cnt = get_news_headlines(page_num);
    total_news_pages = (cnt + 9) // 10 if cnt else 1
    total_count_label.config(text=f"ì´ {cnt:,} ê±´")
    if not news: tk.Label(focus_scrollable_frame, text="ë‰´ìŠ¤ ì—†ìŒ", bg="white").pack(pady=20); return
    for i, n in enumerate(news):
        f = tk.Frame(focus_scrollable_frame, bg="white", height=60);
        f.pack(fill="x");
        f.pack_propagate(False)
        f.grid_columnconfigure(0, weight=1)
        t = tk.Label(f, text=n['title'], font=("ë§‘ì€ ê³ ë”•", 13), bg="white", fg=COLOR_TEXT_MAIN, anchor="w", cursor="hand2")
        t.grid(row=0, column=0, sticky="nsew", padx=15)
        d = tk.Label(f, text=n['date'], font=("ë§‘ì€ ê³ ë”•", 11), fg="#999", bg="white", anchor="e")
        d.grid(row=0, column=1, sticky="nsew", padx=15)
        t.bind("<Button-1>", lambda e, u=n['link']: open_news_link(u))
        t.bind("<Enter>", lambda e, l=t: on_news_enter(e, l));
        t.bind("<Leave>", lambda e, l=t: on_news_leave(e, l))
        if i < len(news) - 1: tk.Frame(focus_scrollable_frame, height=1, bg="#F0F0F0").pack(fill="x")
    page_info_label.config(text=f"{current_news_page} / {total_news_pages}")
    prev_news_button.config(state=tk.NORMAL if current_news_page > 1 else tk.DISABLED)
    next_news_button.config(state=tk.NORMAL if current_news_page < total_news_pages else tk.DISABLED)
    if page_num == 1: threading.Thread(target=update_ai_summary_thread, args=(news,), daemon=True).start()

def show_next_news_page():
    if current_news_page < total_news_pages: populate_focus_page(current_news_page + 1)

def show_prev_news_page():
    if current_news_page > 1: populate_focus_page(current_news_page - 1)

def fetch_all_data_and_check_alerts():
    try:
        data_today = requests.get("https://open.er-api.com/v6/latest/KRW", timeout=10).json()
        if data_today.get("result") == "success":
            global exchange_rates;
            exchange_rates = data_today["rates"]
            yest = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')
            data_yest = requests.get(f"https://api.frankfurter.app/{yest}?from=KRW", timeout=10).json()
            if 'rates' in data_yest:
                global yesterday_exchange_rates
                yesterday_exchange_rates = {c: 1 / r for c, r in data_yest['rates'].items() if r != 0};
                yesterday_exchange_rates['KRW'] = 1.0
            window.after(0, update_ui_and_check_alerts)
    except:
        pass
    finally:
        window.after(ALERT_CHECK_INTERVAL, periodic_update)

def periodic_update(): threading.Thread(target=fetch_all_data_and_check_alerts, daemon=True).start()

def update_ui_and_check_alerts():
    if exchange_page.winfo_viewable(): update_all_displays(); populate_rate_list(); update_alert_list_ui()
    check_alerts()

def populate_rate_list():
    if 'rate_list_scrollable_frame' not in globals(): return
    for w in rate_list_scrollable_frame.winfo_children(): w.destroy()
    if not exchange_rates: return
    currencies = ['USD', 'JPY', 'EUR', 'CNY', 'GBP', 'AUD', 'CAD', 'CHF', 'HKD', 'SGD', 'THB', 'VND', 'TWD']
    for c in currencies:
        if c not in exchange_rates: continue
        curr = 1 / exchange_rates[c];
        prev = yesterday_exchange_rates.get(c, curr);
        chg = curr - prev
        row = tk.Frame(rate_list_scrollable_frame, bg="white");
        row.pack(fill="x", pady=8, padx=15)
        tk.Label(row, image=tk_flag_images.get(f"{c}_small"), bg="white").pack(side="left", padx=(0, 10))
        tk.Label(row, text=f"{currency_data[c]['name']} {c}", font=("ë§‘ì€ ê³ ë”•", 13, "bold"), bg="white",
                 fg=COLOR_TEXT_MAIN).pack(side="left")
        col = "#FF3B30" if chg >= 0 else "#0078D7";
        sym = "â–²" if chg >= 0 else "â–¼"
        tk.Label(row, text=f"{sym} {abs(chg):.2f}", font=("ë§‘ì€ ê³ ë”•", 11), fg=col, bg="white").pack(side="right")
        tk.Label(row, text=f"{curr:,.2f}", font=("ë§‘ì€ ê³ ë”•", 13, "bold"), bg="white", fg=COLOR_TEXT_MAIN).pack(
            side="right", padx=15)
        tk.Frame(rate_list_scrollable_frame, height=1, bg="#F0F0F0").pack(fill="x", padx=15)

def get_historical_data(base, target="KRW", days=30):
    try:
        s = (datetime.now() - timedelta(days=days)).strftime('%Y-%m-%d')
        d = requests.get(f"https://api.frankfurter.app/{s}..?from={base}&to={target}", timeout=10).json()
        if 'rates' in d:
            dates = sorted(d['rates'].keys())
            rates = [d['rates'][dt][target] for dt in dates]
            return [datetime.strptime(dt, '%Y-%m-%d') for dt in dates], rates
    except:
        pass
    return None, None

def draw_graph(dates, rates, base_code):
    if 'graph_content_frame' not in globals(): return
    for w in graph_content_frame.winfo_children(): w.destroy()
    if not dates or not rates: tk.Label(graph_content_frame, text="ë°ì´í„° ë¡œë”© ì¤‘...", bg="white").pack(expand=True); return

    h = tk.Frame(graph_content_frame, bg="white");
    h.pack(fill="x", padx=20, pady=(15, 0))
    if tk_flag_images.get(base_code): tk.Label(h, image=tk_flag_images.get(base_code), bg="white").pack(side="left")
    tk.Label(h, text=f"{currency_data[base_code]['name']} {base_code}", font=("ë§‘ì€ ê³ ë”•", 16, "bold"), bg="white").pack(
        side="left", padx=10)

    curr = rates[-1];
    prev = rates[-2] if len(rates) > 1 else curr;
    chg = curr - prev;
    pct = (chg / prev) * 100 if prev else 0
    tk.Label(h, text=f"{curr:,.2f}", font=("ë§‘ì€ ê³ ë”•", 26, "bold"), bg="white").pack(side="left", padx=(10, 0))
    col = "#FF3B30" if chg >= 0 else "#0078D7";
    sym = "â–²" if chg >= 0 else "â–¼"
    tk.Label(h, text=f"{sym} {chg:,.2f} ({pct:.2f}%)", font=("ë§‘ì€ ê³ ë”•", 12, "bold"), bg="white", fg=col).pack(side="left",
                                                                                                            padx=10,
                                                                                                            pady=(10,
                                                                                                                  0))

    btns = tk.Frame(graph_content_frame, bg="white");
    btns.pack(fill="x", padx=20, pady=(5, 0))
    for t, d in [("1ê°œì›”", 30), ("3ê°œì›”", 90), ("1ë…„", 365)]:
        HoverButton(btns, text=t, font=("ë§‘ì€ ê³ ë”•", 10), bg="#E0E0E0", activebackground="#D0D0D0", relief="flat", padx=8,
                    pady=2,
                    command=lambda x=d: update_chart_by_period(x)).pack(side="left", padx=4)

    fig = Figure(figsize=(10, 5), dpi=100, facecolor="white");
    ax = fig.add_subplot(111)
    ax.plot(dates, rates, color=COLOR_PRIMARY, linewidth=2);
    ax.fill_between(dates, rates, color=COLOR_PRIMARY, alpha=0.1)
    mn = min(rates);
    mx = max(rates);
    pad = (mx - mn) * 0.1;
    ax.set_ylim(mn - pad, mx + pad)
    ax.set_facecolor("white");
    ax.spines['top'].set_visible(False);
    ax.spines['right'].set_visible(False)
    ax.spines['left'].set_color('#DDD');
    ax.spines['bottom'].set_color('#DDD')
    ax.tick_params(axis='x', colors='#666');
    ax.tick_params(axis='y', colors='#666')
    ax.grid(True, linestyle='--', alpha=0.3)
    ax.xaxis.set_major_formatter(mdates.DateFormatter('%m-%d'));
    fig.tight_layout()
    canvas = FigureCanvasTkAgg(fig, master=graph_content_frame);
    canvas.draw();
    canvas.get_tk_widget().pack(fill="both", expand=True, padx=20, pady=(0, 20))

def update_chart_by_period(days=30):
    base = graph_currency_codes[current_graph_index];
    dates, rates = get_historical_data(base, 'KRW', days);
    draw_graph(dates, rates, base)

def show_next_graph(): global current_graph_index; current_graph_index = (current_graph_index + 1) % len(
    graph_currency_codes); update_chart_by_period(30)

def show_prev_graph(): global current_graph_index; current_graph_index = (current_graph_index - 1 + len(
    graph_currency_codes)) % len(graph_currency_codes); update_chart_by_period(30)

def update_conversion_display(*args):
    try:
        amt_str = amount_var.get();
        amt = float(amt_str.replace(',', ''))
        f, t = from_var.get(), to_var.get();
        fr, tr = exchange_rates.get(f, 0), exchange_rates.get(t, 0)
        if fr:
            res = (amt / fr) * tr;
            to_amount_label.config(text=f"{res:,.2f}")
            from_flag_label.config(image=tk_flag_images.get(f));
            to_flag_label.config(image=tk_flag_images.get(t))
            from_country_label.config(text=currency_data[f]['name']);
            to_country_label.config(text=currency_data[t]['name'])
            from_amount_sub_label.config(text=format_korean_number(amt_str, currency_data[f]['symbol']))
            to_amount_sub_label.config(text=format_korean_number(str(res), currency_data[t]['symbol']))
    except:
        pass

def update_all_displays(*args):
    update_conversion_display()
    if from_var.get() in graph_currency_codes:
        global current_graph_index;
        current_graph_index = graph_currency_codes.index(from_var.get());
        update_chart_by_period(30)

def show_page(page_name):
    for n, i in menu_items.items():
        if n == page_name:
            i['btn'].config(bg=COLOR_PRIMARY, fg="white"); i['frame'].tkraise()
        else:
            i['btn'].config(bg="#FFFFFF", fg=COLOR_TEXT_MAIN)
    if page_name == "focus":
        populate_focus_page(1)
    elif page_name == "exchange":
        populate_rate_list(); update_alert_list_ui()

def create_currency_frame(parent, tk_var):
    f = tk.Frame(parent, bg="white");
    f.pack(fill="x", padx=20, pady=5)
    left = tk.Frame(f, bg="white");
    left.pack(side="left")
    tk.Label(left, text="", bg="white").pack(anchor="w")
    tk.Label(left, text="", bg="white", font=("ë§‘ì€ ê³ ë”•", 14, "bold"), fg=COLOR_TEXT_MAIN).pack(anchor="w")
    tk.OptionMenu(left, tk_var, *currency_codes).pack(anchor="w")
    right = tk.Frame(f, bg="white");
    right.pack(side="right", fill="x", expand=True)
    sub = tk.Label(right, text="", font=("ë§‘ì€ ê³ ë”•", 12), fg=COLOR_TEXT_SUB, bg="white", anchor="e")
    return f, {'flag': left.winfo_children()[0], 'country': left.winfo_children()[1], 'right': right, 'sub_label': sub}

exchange_rates = {};
yesterday_exchange_rates = {};
currency_data = {
    'USD': {'name': 'ë¯¸êµ­', 'symbol': 'ë‹¬ëŸ¬', 'flag': 'image/us.png'},
    'KRW': {'name': 'ëŒ€í•œë¯¼êµ­', 'symbol': 'ì›', 'flag': 'image/kr.png'},
    'JPY': {'name': 'ì¼ë³¸', 'symbol': 'ì—”', 'flag': 'image/jp.png'},
    'EUR': {'name': 'ìœ ë¡œì¡´', 'symbol': 'ìœ ë¡œ', 'flag': 'image/eur.png'},
    'CNY': {'name': 'ì¤‘êµ­', 'symbol': 'ìœ„ì•ˆ', 'flag': 'image/cn.png'},
    'GBP': {'name': 'ì˜êµ­', 'symbol': 'íŒŒìš´ë“œ', 'flag': 'image/gbp.png'},
    'AUD': {'name': 'í˜¸ì£¼', 'symbol': 'ë‹¬ëŸ¬', 'flag': 'image/aud.png'},
    'CAD': {'name': 'ìºë‚˜ë‹¤', 'symbol': 'ë‹¬ëŸ¬', 'flag': 'image/cad.png'},
    'CHF': {'name': 'ìŠ¤ìœ„ìŠ¤', 'symbol': 'í”„ë‘', 'flag': 'image/chf.png'},
    'HKD': {'name': 'í™ì½©', 'symbol': 'ë‹¬ëŸ¬', 'flag': 'image/hk.png'},
    'SGD': {'name': 'ì‹±ê°€í¬ë¥´', 'symbol': 'ë‹¬ëŸ¬', 'flag': 'image/sg.png'},
    'THB': {'name': 'íƒœêµ­', 'symbol': 'ë°”íŠ¸', 'flag': 'image/th.png'},
    'VND': {'name': 'ë² íŠ¸ë‚¨', 'symbol': 'ë™', 'flag': 'image/vn.png'},
    'TWD': {'name': 'ëŒ€ë§Œ', 'symbol': 'ë‹¬ëŸ¬', 'flag': 'image/tw.png'}
}
currency_codes = list(currency_data.keys());
graph_currency_codes = ['USD', 'JPY', 'EUR', 'CNY', 'HKD', 'THB', 'VND']
current_graph_index = 0;
current_news_page = 1;
total_news_pages = 1;
user_alerts = [];
ALERT_CHECK_INTERVAL = 600000

window = tk.Tk();
window.title("ì‹¤ì‹œê°„ í™˜ìœ¨ ëŒ€ì‹œë³´ë“œ");
window.geometry("1800x1200");
window.config(bg=COLOR_BG)

style = ttk.Style()
style.theme_use("default")
style.configure("Treeview", background="white", fieldbackground="white", rowheight=35, font=("ë§‘ì€ ê³ ë”•", 12))
style.configure("Treeview.Heading", font=("ë§‘ì€ ê³ ë”•", 12, "bold"), background=COLOR_PRIMARY, foreground="white",
                relief="flat")
style.map("Treeview", background=[('selected', '#E3F2FD')], foreground=[('selected', 'black')])

tk_flag_images = {}
for c, d in currency_data.items():
    try:
        tk_flag_images[c] = ImageTk.PhotoImage(Image.open(d['flag']).resize((50, 32)))
        tk_flag_images[f"{c}_small"] = ImageTk.PhotoImage(Image.open(d['flag']).resize((30, 20)))
    except:
        pass

amount_var = tk.StringVar(value="1");
from_var = tk.StringVar(value='USD');
to_var = tk.StringVar(value='KRW')
alert_currency_var = tk.StringVar(value='USD');
alert_op_var = tk.StringVar(value='>')
prediction_currency_var = tk.StringVar(value='USD');
fee_currency_var = tk.StringVar(value='USD')

sidebar = tk.Frame(window, bg="white", width=250);
sidebar.pack(side="left", fill="y");
sidebar.pack_propagate(False)
tk.Label(sidebar, text="í™˜ìœ¨ ë¹„ì„œ", font=("ë§‘ì€ ê³ ë”•", 24, "bold"), bg="white", fg=COLOR_PRIMARY).pack(pady=(40, 40))
content_area = tk.Frame(window, bg=COLOR_BG);
content_area.pack(side="right", fill="both", expand=True, padx=20, pady=20)
content_area.grid_rowconfigure(0, weight=1);
content_area.grid_columnconfigure(0, weight=1)
exchange_page = tk.Frame(content_area, bg=COLOR_BG);
exchange_page.grid(row=0, column=0, sticky="nsew")
focus_page = tk.Frame(content_area, bg=COLOR_BG);
focus_page.grid(row=0, column=0, sticky="nsew")
fee_page = tk.Frame(content_area, bg=COLOR_BG);
fee_page.grid(row=0, column=0, sticky="nsew")

left_col = tk.Frame(exchange_page, bg=COLOR_BG);
left_col.pack(side="left", fill="both", expand=True, padx=(0, 10))
right_col = tk.Frame(exchange_page, bg=COLOR_BG, width=450);
right_col.pack(side="right", fill="y", padx=(10, 0));
right_col.pack_propagate(False)

conv_card = create_card(left_col, pady=(0, 20))
from_f, from_w = create_currency_frame(conv_card, from_var)
from_flag_label = from_w['flag'];
from_country_label = from_w['country'];
from_amount_sub_label = from_w['sub_label']
tk.Entry(from_w['right'], textvariable=amount_var, font=("ë§‘ì€ ê³ ë”•", 36, "bold"), justify="right", relief="flat",
         bg="white", fg=COLOR_TEXT_MAIN).pack(fill="x")
from_amount_sub_label.pack(fill="x")
tk.Frame(conv_card, height=1, bg="#EEE").pack(fill="x", padx=20, pady=10)
to_f, to_w = create_currency_frame(conv_card, to_var)
to_flag_label = to_w['flag'];
to_country_label = to_w['country'];
to_amount_sub_label = to_w['sub_label']
to_amount_label = tk.Label(to_w['right'], text="", font=("ë§‘ì€ ê³ ë”•", 36, "bold"), bg="white", fg=COLOR_PRIMARY,
                           anchor="e");
to_amount_label.pack(fill="x")
to_amount_sub_label.pack(fill="x")

graph_card = create_card(left_col)
graph_container = tk.Frame(graph_card, bg="white");
graph_container.pack(fill="both", expand=True)
HoverButton(graph_container, text="â—€", font=("Arial", 16), bg="white", relief="flat", command=show_prev_graph).pack(
    side="left", fill="y")
graph_content_frame = tk.Frame(graph_container, bg="white");
graph_content_frame.pack(side="left", fill="both", expand=True)
HoverButton(graph_container, text="â–¶", font=("Arial", 16), bg="white", relief="flat", command=show_next_graph).pack(
    side="right", fill="y")

alert_card = create_card(right_col, pady=(0, 20))
tk.Label(alert_card, text="í™˜ìœ¨ ì•Œë¦¼", font=("ë§‘ì€ ê³ ë”•", 16, "bold"), bg="white").pack(anchor="w", padx=20, pady=15)
alert_in = tk.Frame(alert_card, bg="white");
alert_in.pack(fill="x", padx=20)
tk.OptionMenu(alert_in, alert_currency_var, *graph_currency_codes).pack(side="left")
tk.OptionMenu(alert_in, alert_op_var, ">", "<").pack(side="left", padx=5)
alert_value_entry = tk.Entry(alert_in, font=("ë§‘ì€ ê³ ë”•", 12), width=10, bg="#F5F5F5", relief="flat");
alert_value_entry.pack(side="left", padx=5)
HoverButton(alert_in, text="ì¶”ê°€", bg=COLOR_PRIMARY, fg="white", font=("ë§‘ì€ ê³ ë”•", 10, "bold"), relief="flat", padx=10,
            command=add_alert).pack(side="right")
alert_list_frame = tk.Frame(alert_card, bg="white", height=200);
alert_list_frame.pack(fill="both", expand=True, padx=10, pady=10);
alert_list_frame.pack_propagate(False)
alert_canvas = tk.Canvas(alert_list_frame, bg="white", highlightthickness=0);
alert_scroll = tk.Scrollbar(alert_list_frame, command=alert_canvas.yview)
alert_list_inner_frame = tk.Frame(alert_canvas, bg="white")
alert_list_inner_frame.bind("<Configure>", lambda e: alert_canvas.configure(scrollregion=alert_canvas.bbox("all")))
alert_canvas.create_window((0, 0), window=alert_list_inner_frame, anchor="nw", width=400)
alert_canvas.configure(yscrollcommand=alert_scroll.set);
alert_canvas.pack(side="left", fill="both", expand=True);
alert_scroll.pack(side="right", fill="y")

rate_card = create_card(right_col)
tk.Label(rate_card, text="ì‹¤ì‹œê°„ ì‹œì„¸", font=("ë§‘ì€ ê³ ë”•", 16, "bold"), bg="white").pack(anchor="w", padx=20, pady=15)
rate_canvas = tk.Canvas(rate_card, bg="white", highlightthickness=0);
rate_scroll = tk.Scrollbar(rate_card, command=rate_canvas.yview)
rate_list_scrollable_frame = tk.Frame(rate_canvas, bg="white");
rate_list_scrollable_frame.bind("<Configure>", lambda e: rate_canvas.configure(scrollregion=rate_canvas.bbox("all")))
rate_canvas.create_window((0, 0), window=rate_list_scrollable_frame, anchor="nw", width=400)
rate_canvas.configure(yscrollcommand=rate_scroll.set);
rate_canvas.pack(side="left", fill="both", expand=True);
rate_scroll.pack(side="right", fill="y")

sum_card = create_card(focus_page, pady=(0, 20))
tk.Label(sum_card, text="AI ì‹œì¥ ìš”ì•½", font=("ë§‘ì€ ê³ ë”•", 16, "bold"), bg="white", fg=COLOR_PRIMARY).pack(anchor="w", padx=20,
                                                                                                   pady=(20, 10))
ai_summary_label = tk.Label(sum_card, text="ë¶„ì„ ì¤‘...", font=("ë§‘ì€ ê³ ë”•", 12), bg="white", justify="left", wraplength=1200);
ai_summary_label.pack(fill="x", padx=20, pady=(0, 20))

pred_card = create_card(focus_page, pady=(0, 20))
pred_head = tk.Frame(pred_card, bg="white");
pred_head.pack(fill="x", padx=20, pady=20)
tk.Label(pred_head, text="í™˜ìœ¨ ì˜ˆì¸¡ ì‹œë®¬ë ˆì´ì…˜", font=("ë§‘ì€ ê³ ë”•", 16, "bold"), bg="white").pack(side="left")
tk.OptionMenu(pred_head, prediction_currency_var, *currency_codes).pack(side="left", padx=20)
predict_button = HoverButton(pred_head, text="AI ì˜ˆì¸¡ ì‹¤í–‰", bg=COLOR_PRIMARY, fg="white", font=("ë§‘ì€ ê³ ë”•", 12, "bold"),
                             relief="flat", padx=15, pady=5,
                             command=lambda: threading.Thread(target=run_prediction_thread, daemon=True).start());
predict_button.pack(side="left")
pred_body = tk.Frame(pred_card, bg="white");
pred_body.pack(fill="both", expand=True, padx=20, pady=(0, 20))
prediction_result_text = scrolledtext.ScrolledText(pred_body, height=8, font=("ë§‘ì€ ê³ ë”•", 12), bg="#F9F9F9", relief="flat",
                                                   padx=10, pady=10);
prediction_result_text.pack(side="left", fill="both", expand=True)
gauge_canvas = tk.Canvas(pred_body, width=300, height=220, bg="white", highlightthickness=0);
gauge_canvas.pack(side="right", padx=(20, 0))
draw_gauge(gauge_canvas, 50)

news_card = create_card(focus_page)
total_count_label = tk.Label(news_card, text="ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸", font=("ë§‘ì€ ê³ ë”•", 14, "bold"), bg="white");
total_count_label.pack(anchor="w", padx=20, pady=15)
focus_canvas = tk.Canvas(news_card, bg="white", highlightthickness=0);
focus_scroll = tk.Scrollbar(news_card, command=focus_canvas.yview)
focus_scrollable_frame = tk.Frame(focus_canvas, bg="white");
focus_scrollable_frame.bind("<Configure>", lambda e: focus_canvas.configure(scrollregion=focus_canvas.bbox("all")))
focus_canvas.create_window((0, 0), window=focus_scrollable_frame, anchor="nw");
focus_canvas.configure(yscrollcommand=focus_scroll.set)
focus_canvas.pack(side="left", fill="both", expand=True);
focus_scroll.pack(side="right", fill="y")
nav = tk.Frame(focus_page, bg=COLOR_BG);
nav.pack(side="bottom", fill="x", pady=20)
prev_news_button = HoverButton(nav, text="â—€ ì´ì „", font=("ë§‘ì€ ê³ ë”•", 12), bg="white", relief="flat",
                               command=show_prev_news_page);
prev_news_button.pack(side="left")
page_info_label = tk.Label(nav, text="1 / 1", bg=COLOR_BG);
page_info_label.pack(side="left", expand=True)
next_news_button = HoverButton(nav, text="ë‹¤ìŒ â–¶", font=("ë§‘ì€ ê³ ë”•", 12), bg="white", relief="flat",
                               command=show_next_news_page);
next_news_button.pack(side="right")

fee_card = create_card(fee_page)
tk.Label(fee_card, text="ìŠ¤ë§ˆíŠ¸ í™˜ì „ ê³„ì‚°ê¸°", font=("ë§‘ì€ ê³ ë”•", 20, "bold"), bg="white", fg=COLOR_PRIMARY).pack(anchor="w",
                                                                                                     padx=30,
                                                                                                     pady=(30, 5))
tk.Label(fee_card, text="ê°€ì¥ ìœ ë¦¬í•œ í™˜ì „ì†Œë¥¼ AIê°€ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤.", font=("ë§‘ì€ ê³ ë”•", 12), bg="white", fg=COLOR_TEXT_SUB).pack(anchor="w",
                                                                                                             padx=30,
                                                                                                             pady=(0,
                                                                                                                   20))
in_f = tk.Frame(fee_card, bg="#F5F9FF", padx=20, pady=20);
in_f.pack(fill="x", padx=30)
tk.Label(in_f, text="í™˜ì „ ê¸ˆì•¡ (KRW):", font=("ë§‘ì€ ê³ ë”•", 12, "bold"), bg="#F5F9FF").pack(side="left")
fee_amount_entry = tk.Entry(in_f, font=("ë§‘ì€ ê³ ë”•", 12), width=15);
fee_amount_entry.pack(side="left", padx=10);
fee_amount_entry.insert(0, "1000000")
tk.Label(in_f, text="â†’  ëŒ€ìƒ í†µí™”:", font=("ë§‘ì€ ê³ ë”•", 12), bg="#F5F9FF").pack(side="left", padx=10)
tk.OptionMenu(in_f, fee_currency_var, *[c for c in currency_codes if c != 'KRW']).pack(side="left")
HoverButton(in_f, text="ìµœì €ê°€ ë¹„êµ & AI ë¶„ì„", font=("ë§‘ì€ ê³ ë”•", 12, "bold"), bg=COLOR_PRIMARY, fg="white", relief="flat",
            padx=15, command=calculate_fees_and_recommend).pack(side="right")
fee_tree = ttk.Treeview(fee_card, columns=("method", "rate", "total", "note"), show="headings", height=5)
fee_tree.heading("method", text="í™˜ì „ ë°©ë²•");
fee_tree.heading("rate", text="ì ìš© í™˜ìœ¨");
fee_tree.heading("total", text="ì‹¤ì œ ìˆ˜ë ¹ì•¡");
fee_tree.heading("note", text="ë¹„ê³ ")
fee_tree.column("method", width=200);
fee_tree.column("rate", width=120, anchor="e");
fee_tree.column("total", width=150, anchor="e");
fee_tree.column("note", width=250)
fee_tree.tag_configure('recommend', background='#E3F2FD');
fee_tree.pack(fill="x", padx=30, pady=20)

tk.Label(fee_card, text="ğŸ’¡ AI ê¸ˆìœµ ì¡°ì–¸", font=("ë§‘ì€ ê³ ë”•", 14, "bold"), bg="white").pack(anchor="w", padx=30)
fee_ai_card_container = tk.Frame(fee_card, bg="white");
fee_ai_card_container.pack(fill="x", padx=30, pady=10)
tk.Label(fee_ai_card_container, text="ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”. AIê°€ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.", bg="white", fg="#999").pack(
    pady=20)

menu_items = {}

def menu_cmd(name): show_page(name)

def create_menu_btn(name, text):
    btn = HoverButton(sidebar, text=text, font=("ë§‘ì€ ê³ ë”•", 14, "bold"), bg="white", fg=COLOR_TEXT_MAIN, relief="flat",
                      pady=15, command=lambda: menu_cmd(name))
    btn.pack(fill="x");
    menu_items[name] = {'btn': btn, 'frame': eval(f"{name}_page")}

create_menu_btn('exchange', 'ğŸ“ˆ í™˜ìœ¨ ì¡°íšŒ');
create_menu_btn('focus', 'ğŸ“° AI í¬ì»¤ìŠ¤');
create_menu_btn('fee', 'ğŸ’° ìˆ˜ìˆ˜ë£Œ ë¹„êµ')

amount_var.trace("w", update_conversion_display);
from_var.trace("w", update_all_displays);
to_var.trace("w", update_all_displays)
show_page("exchange");
periodic_update();
window.mainloop()
