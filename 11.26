# --- 라이브러리 임포트 ---
import tkinter as tk
from tkinter import messagebox, scrolledtext
import requests
from bs4 import BeautifulSoup
import webbrowser
import threading
import math  # 계기판 그리기용 수학 모듈
from PIL import Image, ImageTk
from datetime import datetime, timedelta
import matplotlib

matplotlib.rcParams['font.family'] = 'Malgun Gothic'
matplotlib.use("TkAgg")
from matplotlib.figure import Figure
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import matplotlib.dates as mdates
from matplotlib.ticker import MaxNLocator


# --- 1. 모든 함수 정의 (최상단 배치) ---

def check_alerts():
    if not exchange_rates: return
    triggered_alerts = []
    for alert in list(user_alerts):
        try:
            current_rate = 1 / exchange_rates.get(alert['code'], 0)
            if current_rate == 0: continue
            condition_met = False
            if alert['op'] == '>' and current_rate > alert['value']:
                condition_met = True
            elif alert['op'] == '<' and current_rate < alert['value']:
                condition_met = True
            if condition_met:
                msg = f"환율 알림!\n\n{alert['code']} 환율이 설정하신 {alert['value']}원 {alert['op']} 도달했습니다.\n\n현재 환율: {current_rate:,.2f}원"
                messagebox.showinfo("환율 변동 알림", msg)
                triggered_alerts.append(alert)
        except Exception as e:
            print(f"알림 확인 중 오류: {e}")
    for alert in triggered_alerts:
        if alert in user_alerts: user_alerts.remove(alert)
    if exchange_page.winfo_viewable(): update_alert_list_ui()


def add_alert():
    code = alert_currency_var.get();
    op = alert_op_var.get();
    value_str = alert_value_entry.get()
    try:
        value = float(value_str)
        if value <= 0: raise ValueError
    except ValueError:
        messagebox.showwarning("입력 오류", "목표 환율은 0보다 큰 숫자로 입력해야 합니다."); return
    new_alert = {'code': code, 'op': op, 'value': value}
    user_alerts.append(new_alert)
    alert_value_entry.delete(0, tk.END)
    update_alert_list_ui()


def remove_alert(alert_to_remove):
    global user_alerts;
    user_alerts = [alert for alert in user_alerts if alert != alert_to_remove]
    update_alert_list_ui()


def update_alert_list_ui():
    if 'alert_list_frame' in globals():
        for widget in alert_list_frame.winfo_children(): widget.destroy()
        if not user_alerts:
            tk.Label(alert_list_frame, text="현재 설정된 알림이 없습니다.", font=("맑은 고딕", 12), bg="white", fg="gray").pack(pady=5)
        else:
            for alert in user_alerts:
                alert_frame = tk.Frame(alert_list_frame, bg="#F0F0F0")
                alert_text = f"{alert['code']} 환율이 {alert['value']}원 {alert['op']} 일 때 알림"
                tk.Label(alert_frame, text=alert_text, font=("맑은 고딕", 11), bg="#F0F0F0", fg="black").pack(side="left",
                                                                                                          padx=10,
                                                                                                          pady=5)
                tk.Button(alert_frame, text="X", font=("Arial", 10, "bold"), fg="red", relief="flat", bg="#F0F0F0",
                          command=lambda a=alert: remove_alert(a)).pack(side="right", padx=5)
                alert_frame.pack(fill="x", pady=2)


# --- AI 관련 함수 ---

def get_gemini_response(system_prompt, user_prompt):
    api_key = "AIzaSyDWY_TkkNE4rQiy4rfh0mzNDAeh3-fvYDg"  # ⚠️ API 키
    if not api_key: return "오류: API 키가 설정되지 않았습니다."
    api_url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key={api_key}"
    payload = {"contents": [{"parts": [{"text": user_prompt}]}],
               "systemInstruction": {"parts": [{"text": system_prompt}]}}
    try:
        response = requests.post(api_url, json=payload, headers={'Content-Type': 'application/json'}, timeout=30)
        response.raise_for_status();
        result = response.json()
        return result['candidates'][0]['content']['parts'][0]['text']
    except Exception as e:
        return f"오류 발생: {e}"


def get_ai_summary(headlines):
    system_prompt = "당신은 외환 시장 분석가입니다. 뉴스 헤드라인을 바탕으로 원화(KRW) 환율 시장의 주요 이슈를 한국어로 3줄 이내로 요약해 주세요."
    headlines_text = "\n".join([f"- {h['title']}" for h in headlines])
    user_prompt = f"최신 환율 뉴스:\n{headlines_text}\n\n위 내용을 요약해 주세요."
    return get_gemini_response(system_prompt, user_prompt)


def get_ai_prediction_with_score(target_code, headlines):
    target_name = currency_data.get(target_code, {}).get('name', target_code)
    system_prompt = (f"당신은 {target_name}({target_code}) 환율 예측 전문가입니다. "
                     f"뉴스 헤드라인을 분석하여 향후 일주일간의 추세를 예측하세요. "
                     "반드시 다음 형식을 지켜 답변하세요:\n"
                     "1. 예측: [상승 / 하락 / 보합] 중 택1\n"
                     "2. 분석: 3문장 내외 설명\n"
                     "3. 조언: 한 줄 투자 조언\n"
                     "4. SCORE: 0~100 사이의 정수 (0=폭락예상, 50=변동없음, 100=폭등예상). "
                     "마지막 줄은 반드시 'SCORE: 75' 처럼 점수만 적으세요.")

    headlines_text = "\n".join([f"- {h['title']}" for h in headlines]) or "(뉴스 없음)"
    user_prompt = f"분석 대상: {target_name} {target_code}\n참고 뉴스:\n{headlines_text}\n\n환율 추세를 예측해 주세요."
    return get_gemini_response(system_prompt, user_prompt)


def run_prediction_thread():
    target_code = prediction_currency_var.get()
    if not target_code: return

    predict_button.config(state=tk.DISABLED, text="분석 중...", bg="gray")
    prediction_result_text.config(state=tk.NORMAL);
    prediction_result_text.delete("1.0", tk.END)
    prediction_result_text.insert(tk.END, f"AI가 {target_code} 관련 뉴스를 분석 중입니다...\n\n(계기판을 준비하는 중...)")
    prediction_result_text.config(state=tk.DISABLED)

    headlines, _ = get_news_headlines(current_news_page)
    full_text = get_ai_prediction_with_score(target_code, headlines)

    score = 50
    clean_text = full_text
    try:
        lines = full_text.strip().split('\n')
        last_line = lines[-1].strip()
        if "SCORE:" in last_line:
            score_part = last_line.split("SCORE:")[1].strip()
            score = int(float(score_part))
            clean_text = "\n".join(lines[:-1]).strip()
    except Exception as e:
        print(f"점수 파싱 실패: {e}")

    window.after(0, lambda: update_prediction_ui(clean_text, score))


def update_prediction_ui(result_text, score):
    prediction_result_text.config(state=tk.NORMAL)
    prediction_result_text.delete("1.0", tk.END)
    prediction_result_text.insert(tk.END, result_text)
    prediction_result_text.config(state=tk.DISABLED)

    draw_gauge(gauge_canvas, score)
    predict_button.config(state=tk.NORMAL, text="AI 예측 실행", bg="#0078D7")


def draw_gauge(canvas, score):
    """(수정됨) 캔버스 높이를 늘리고 좌표를 조정하여 글자 잘림 해결"""
    # 캔버스 높이를 220으로 강제 조정하여 공간 확보
    canvas.config(height=220)
    canvas.delete("all")

    w = 300
    cx = w / 2
    # 중심점(cy)을 적절히 내려서 위쪽 글자("보합")가 잘리지 않게 함
    cy = 150
    radius = 110  # 반지름을 살짝 줄여서 여유 공간 확보

    # 1. 배경 아크
    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius, start=0, extent=180, outline="#F0F0F0",
                      width=30, style="arc")

    # 구간별 색상
    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius, start=120, extent=60, outline="#0078D7",
                      width=25, style="arc")  # 하락
    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius, start=60, extent=60, outline="gray", width=25,
                      style="arc")  # 보합
    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius, start=0, extent=60, outline="#FF3B30",
                      width=25, style="arc")  # 상승

    # 2. 텍스트 라벨 (그래프 바깥쪽 배치)
    text_r = radius + 25  # 글자 위치 반지름

    # 하락 (150도)
    x1 = cx + text_r * math.cos(math.radians(150))
    y1 = cy - text_r * math.sin(math.radians(150))
    canvas.create_text(x1, y1, text="하락", font=("맑은 고딕", 11, "bold"), fill="#0078D7")

    # 보합 (90도) - 이제 캔버스 높이가 충분해서 안 잘림
    x2 = cx + text_r * math.cos(math.radians(90))
    y2 = cy - text_r * math.sin(math.radians(90))
    canvas.create_text(x2, y2, text="보합", font=("맑은 고딕", 11, "bold"), fill="gray")

    # 상승 (30도)
    x3 = cx + text_r * math.cos(math.radians(30))
    y3 = cy - text_r * math.sin(math.radians(30))
    canvas.create_text(x3, y3, text="상승", font=("맑은 고딕", 11, "bold"), fill="#FF3B30")

    # 3. 바늘 그리기
    angle = 180 - (score * 1.8)
    angle_rad = math.radians(angle)
    needle_len = radius - 10
    nx = cx + needle_len * math.cos(angle_rad)
    ny = cy - needle_len * math.sin(angle_rad)

    canvas.create_line(cx, cy, nx, ny, width=4, fill="black", arrow=tk.LAST, arrowshape=(10, 12, 5))
    canvas.create_oval(cx - 5, cy - 5, cx + 5, cy + 5, fill="black")

    # 4. 점수 표시 (바늘 아래쪽 여유 공간에 배치)
    color = "#FF3B30" if score > 60 else "#0078D7" if score < 40 else "gray"
    canvas.create_text(cx, cy + 40, text=f"심리 지수: {score}", font=("맑은 고딕", 16, "bold"), fill=color)


# --- 크롤링 및 기타 함수 ---

def get_news_headlines(page_num=1):
    url = f"https://www.kita.net/cmmrcInfo/ehgtNews/ehgtNewsList.do?pageIndex={page_num}"
    news_list = [];
    total_news_count = 0
    try:
        response = requests.get(url, timeout=10);
        response.raise_for_status()
        soup = BeautifulSoup(response.text, "html.parser")
        summary_div = soup.find("div", class_="bbs-summary");
        if summary_div and summary_div.find("strong"):
            try:
                total_news_count = int(summary_div.find("strong").text.replace(',', ''))
            except ValueError:
                pass
        news_ul = soup.find("ul", class_="board-list");
        if not news_ul: return [], 0
        for item in news_ul.find_all("li"):
            subject_div = item.find("div", class_="subject");
            info_div = item.find("div", class_="info");
            date_text = ""
            if info_div:
                date_span = info_div.find("span", class_="date")
                if date_span: date_text = date_span.text.strip()
            if subject_div:
                link_tag = subject_div.find("a")
                if link_tag and link_tag.has_attr('onclick'):
                    onclick_attr = link_tag['onclick']
                    try:
                        params = onclick_attr.split('(')[1].split(')')[0].replace("'", "").split(',')
                        link = f"https://www.kita.net/cmmrcInfo/ehgtNews/ehgtNewsDetail.do?classification={params[0].strip()}&no={params[1].strip()}"
                        title = link_tag.text.strip()
                        if title: news_list.append({'title': title, 'link': link, 'date': date_text})
                    except:
                        pass
    except Exception as e:
        print(f"뉴스 파싱 오류: {e}")
    return news_list[:15], total_news_count


def open_news_link(url):
    try:
        webbrowser.open(url, new=2)
    except:
        pass


def on_news_enter(e, label): label.config(font=("맑은 고딕", 14, "bold"), fg="#1E90FF")


def on_news_leave(e, label): label.config(font=("맑은 고딕", 13), fg="black")


def populate_focus_page(page_num=1):
    for widget in focus_scrollable_frame.winfo_children(): widget.destroy()
    global current_news_page, total_news_pages;
    current_news_page = page_num

    if page_num == 1:
        ai_summary_label.config(text="AI가 최신 뉴스를 분석 중입니다...")
    else:
        ai_summary_label.config(text="AI 요약은 첫 페이지만 지원됩니다.")

    news_headlines, total_count = get_news_headlines(page_num)
    total_news_pages = (total_count + 9) // 10 if total_count > 0 else 1
    total_count_label.config(text=f"총 {total_count:,} 건")

    if not news_headlines:
        tk.Label(focus_scrollable_frame, text="뉴스를 불러올 수 없습니다.", font=("맑은 고딕", 16)).pack(pady=28);
        return

    for i, news in enumerate(news_headlines):
        item_frame = tk.Frame(focus_scrollable_frame, bg="white", height=60);
        item_frame.pack(fill="x");
        item_frame.pack_propagate(False)
        item_frame.grid_columnconfigure(0, weight=1)
        title_lbl = tk.Label(item_frame, text=news['title'], font=("맑은 고딕", 13), bg="white", anchor="w", cursor="hand2")
        title_lbl.grid(row=0, column=0, sticky="nsew", padx=14)
        date_lbl = tk.Label(item_frame, text=news['date'], font=("맑은 고딕", 12), fg="gray", bg="white", anchor="e")
        date_lbl.grid(row=0, column=1, sticky="nsew", padx=14)
        title_lbl.bind("<Button-1>", lambda e, u=news['link']: open_news_link(u))
        title_lbl.bind("<Enter>", lambda e, l=title_lbl: on_news_enter(e, l))
        title_lbl.bind("<Leave>", lambda e, l=title_lbl: on_news_leave(e, l))
        if i < len(news_headlines) - 1: tk.Frame(focus_scrollable_frame, height=1, bg="#F0F0F0").pack(fill="x")

    page_info_label.config(text=f"페이지 {current_news_page} / {total_news_pages}")
    prev_news_button.config(state=tk.NORMAL if current_news_page > 1 else tk.DISABLED)
    next_news_button.config(state=tk.NORMAL if current_news_page < total_news_pages else tk.DISABLED)
    if page_num == 1 and news_headlines: threading.Thread(target=update_ai_summary_thread, args=(news_headlines,),
                                                          daemon=True).start()


def show_next_news_page():
    if current_news_page < total_news_pages: populate_focus_page(current_news_page + 1)


def show_prev_news_page():
    if current_news_page > 1: populate_focus_page(current_news_page - 1)


def fetch_all_data_and_check_alerts():
    try:
        url_today = "https://open.er-api.com/v6/latest/KRW"
        data_today = requests.get(url_today, timeout=10).json()
        if data_today.get("result") == "success":
            global exchange_rates;
            exchange_rates = data_today["rates"]
            yesterday = datetime.now() - timedelta(days=1);
            date_str = yesterday.strftime('%Y-%m-%d')
            url_yest = f"https://api.frankfurter.app/{date_str}?from=KRW"
            data_yest = requests.get(url_yest, timeout=10).json()
            if 'rates' in data_yest:
                global yesterday_exchange_rates
                yesterday_exchange_rates = {code: 1 / rate for code, rate in data_yest.get('rates', {}).items() if
                                            rate != 0}
                yesterday_exchange_rates['KRW'] = 1.0
            window.after(0, update_ui_and_check_alerts)
    except Exception as e:
        print(f"업데이트 오류: {e}")
    finally:
        window.after(ALERT_CHECK_INTERVAL, periodic_update)


def periodic_update(): threading.Thread(target=fetch_all_data_and_check_alerts, daemon=True).start()


def update_ui_and_check_alerts():
    if exchange_page.winfo_viewable():
        update_all_displays();
        populate_rate_list();
        update_alert_list_ui()
    check_alerts()


def populate_rate_list():
    if 'rate_list_scrollable_frame' not in globals(): return
    for widget in rate_list_scrollable_frame.winfo_children(): widget.destroy()
    if not exchange_rates: return
    focus_currencies = ['USD', 'JPY', 'EUR', 'CNY', 'GBP', 'AUD', 'CAD', 'CHF']
    for code in focus_currencies:
        if code not in exchange_rates: continue
        today_rate = 1 / exchange_rates[code]
        row = tk.Frame(rate_list_scrollable_frame, bg="white");
        row.pack(fill="x", pady=7, padx=14)
        tk.Label(row, image=tk_flag_images.get(f"{code}_small"), bg="white").pack(side="left", padx=(0, 10))
        tk.Label(row, text=f"{currency_data[code]['name']} {code}", font=("맑은 고딕", 14, "bold"), bg="white", width=12,
                 anchor="w").pack(side="left")
        yesterday_rate = yesterday_exchange_rates.get(code, today_rate);
        change = today_rate - yesterday_rate
        color = "red" if change >= 0 else "blue";
        symbol = "▲" if change >= 0 else "▼"
        tk.Label(row, text=f"{symbol} {abs(change):.2f}", font=("맑은 고딕", 12), fg=color, bg="white").pack(side="right")
        tk.Label(row, text=f"{today_rate:,.2f}", font=("맑은 고딕", 14, "bold"), bg="white").pack(side="right", padx=10)
        tk.Frame(rate_list_scrollable_frame, height=1, bg="#F0F0F0").pack(fill="x", padx=14)


def get_historical_data(base, target="KRW", days=30):
    today = datetime.now();
    start = (today - timedelta(days=days)).strftime('%Y-%m-%d')
    url = f"https://api.frankfurter.app/{start}..?from={base}&to={target}"
    try:
        data = requests.get(url, timeout=10).json()
        if 'rates' in data:
            dates = sorted(data['rates'].keys())
            rates = [data['rates'][d][target] for d in dates]
            dates_dt = [datetime.strptime(d, '%Y-%m-%d') for d in dates]
            if dates_dt and dates_dt[-1].date() != today.date() and (base in exchange_rates):
                dates_dt.append(today);
                rates.append(1 / exchange_rates[base])
            return dates_dt, rates
    except:
        pass
    return None, None


def draw_graph(dates, rates, base_code):
    if 'graph_content_frame' not in globals(): return
    for widget in graph_content_frame.winfo_children(): widget.destroy()
    if not dates or not rates:
        tk.Label(graph_content_frame, text="데이터 부족", font=("맑은 고딕", 18), bg="white").pack(expand=True);
        return
    header = tk.Frame(graph_content_frame, bg="white");
    header.pack(fill="x", padx=12, pady=(12, 0))
    if tk_flag_images.get(base_code): tk.Label(header, image=tk_flag_images.get(base_code), bg="white").pack(
        side="left")
    tk.Label(header, text=f"{currency_data[base_code]['name']} {base_code}", font=("맑은 고딕", 14, "bold"),
             bg="white").pack(side="left", padx=(6, 12))
    curr = rates[-1];
    prev = rates[-2] if len(rates) > 1 else curr;
    change = curr - prev;
    pct = (change / prev) * 100 if prev else 0
    tk.Label(header, text=f"{curr:,.2f}", font=("맑은 고딕", 24, "bold"), bg="white").pack(side="left")
    color = "red" if change >= 0 else "blue";
    symb = "▲" if change >= 0 else "▼"
    tk.Label(header, text=f"{symb} {change:,.2f} ({pct:.2f}%)", font=("맑은 고딕", 12), bg="white", fg=color).pack(
        side="left", pady=(6, 0))

    btns = tk.Frame(graph_content_frame, bg="white");
    btns.pack(fill="x", padx=12, pady=(6, 0))
    for t, d in [("1개월", 30), ("3개월", 90), ("1년", 365)]:
        tk.Button(btns, text=t, font=("맑은 고딕", 11), relief="flat", bg="white",
                  command=lambda x=d: update_chart_by_period(x)).pack(side="left", padx=4)

    fig = Figure(figsize=(6, 3.6), dpi=100, facecolor="white");
    ax = fig.add_subplot(111)
    ax.plot(dates, rates, color='royalblue', linewidth=1.8);
    ax.fill_between(dates, rates, color='royalblue', alpha=0.1)
    mx = max(rates);
    mn = min(rates);
    ax.set_ylim(mn - (mx - mn) * 0.1, mx + (mx - mn) * 0.1)
    ax.set_facecolor("white");
    ax.spines['top'].set_visible(False);
    ax.spines['right'].set_visible(False)
    ax.xaxis.set_major_formatter(mdates.DateFormatter('%m-%d'));
    fig.tight_layout()
    canvas = FigureCanvasTkAgg(fig, master=graph_content_frame);
    canvas.draw();
    canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True, padx=12, pady=(0, 12))


def update_chart_by_period(days=30):
    base = graph_currency_codes[current_graph_index];
    dates, rates = get_historical_data(base, 'KRW', days);
    draw_graph(dates, rates, base)


def show_next_graph(): global current_graph_index; current_graph_index = (
                                                                                     current_graph_index + 1) % 4; update_chart_by_period(
    30)


def show_prev_graph(): global current_graph_index; current_graph_index = (
                                                                                     current_graph_index - 1 + 4) % 4; update_chart_by_period(
    30)


def update_conversion_display(*args):
    try:
        amt = float(amount_var.get().replace(',', ''))
        f, t = from_var.get(), to_var.get()
        fr, tr = exchange_rates.get(f, 0), exchange_rates.get(t, 0)
        if fr:
            to_amount_label.config(text=f"{(amt / fr) * tr:,.2f}")
            from_flag_label.config(image=tk_flag_images.get(f));
            to_flag_label.config(image=tk_flag_images.get(t))
            from_country_label.config(text=currency_data[f]['name']);
            to_country_label.config(text=currency_data[t]['name'])
    except:
        pass


def update_all_displays(*args):
    update_conversion_display()
    if from_var.get() in graph_currency_codes:
        global current_graph_index;
        current_graph_index = graph_currency_codes.index(from_var.get());
        update_chart_by_period(30)


def show_page(page_name):
    for name, items in menu_items.items():
        if name == page_name:
            items['button'].config(fg="black", bg="#F5F5F5");
            items['underline'].pack(fill="x", padx=14, pady=(0, 7));
            items['page'].tkraise()
        else:
            items['button'].config(fg="gray", bg="#F5F5F5");
            items['underline'].pack_forget()
    if page_name == "focus":
        populate_focus_page(1)
    elif page_name == "exchange":
        populate_rate_list(); update_alert_list_ui()


def create_currency_frame(parent, tk_var):
    frame = tk.Frame(parent, bg="white", highlightbackground="#E0E0E0", highlightthickness=1)
    left = tk.Frame(frame, bg="white", width=216, height=172);
    left.pack(side="left", padx=14, pady=14);
    left.pack_propagate(False)
    tk.Label(left, text="", bg="white").grid(row=0, column=0)
    tk.Label(left, text="", bg="white", font=("맑은 고딕", 16, "bold")).grid(row=1, column=0)
    tk.OptionMenu(left, tk_var, *currency_codes).grid(row=3, column=0)
    tk.Frame(frame, bg="#E0E0E0", width=1).pack(side="left", fill="y", pady=14)
    right = tk.Frame(frame, bg="white");
    right.pack(side="right", fill="both", expand=True, padx=14, pady=14)
    return frame, {'flag': left.winfo_children()[0], 'country': left.winfo_children()[1], 'right': right}


# --- 2. 전역 변수 ---
exchange_rates = {};
yesterday_exchange_rates = {}
currency_data = {
    'USD': {'name': '미국', 'symbol': '달러', 'flag': 'image/us.png'},
    'KRW': {'name': '대한민국', 'symbol': '원', 'flag': 'image/kr.png'},
    'JPY': {'name': '일본', 'symbol': '엔', 'flag': 'image/jp.png'},
    'EUR': {'name': '유로존', 'symbol': '유로', 'flag': 'image/eur.png'},
    'CNY': {'name': '중국', 'symbol': '위안', 'flag': 'image/cn.png'},
    'GBP': {'name': '영국', 'symbol': '파운드', 'flag': 'image/gbp.png'},
    'AUD': {'name': '호주', 'symbol': '달러', 'flag': 'image/aud.png'},
    'CAD': {'name': '캐나다', 'symbol': '달러', 'flag': 'image/cad.png'},
    'CHF': {'name': '스위스', 'symbol': '프랑', 'flag': 'image/chf.png'}
}
currency_codes = list(currency_data.keys());
graph_currency_codes = ['USD', 'JPY', 'EUR', 'CNY']
current_graph_index = 0;
current_news_page = 1;
total_news_pages = 1
user_alerts = [];
ALERT_CHECK_INTERVAL = 600000

# --- 3. GUI 설정 ---
window = tk.Tk();
window.title("실시간 환율 정보 & AI 분석");
window.geometry("1800x1200");
window.config(bg="white")

# --- 4. 이미지 ---
tk_flag_images = {}
for code, data in currency_data.items():
    try:
        tk_flag_images[code] = ImageTk.PhotoImage(Image.open(data['flag']).resize((58, 37)))
        tk_flag_images[f"{code}_small"] = ImageTk.PhotoImage(Image.open(data['flag']).resize((36, 24)))
    except:
        pass

# --- 5. 변수 ---
amount_var = tk.StringVar(value="1");
from_var = tk.StringVar(value='USD');
to_var = tk.StringVar(value='KRW')
alert_currency_var = tk.StringVar(value='USD');
alert_op_var = tk.StringVar(value='>')
prediction_currency_var = tk.StringVar(value='USD')

# --- 6. 레이아웃 ---
sidebar_container = tk.Frame(window);
sidebar_container.pack(side="left", fill="y")
sidebar_frame = tk.Frame(sidebar_container, bg="#F5F5F5", width=216);
sidebar_frame.pack(side="left", fill="y", expand=False);
sidebar_frame.pack_propagate(False)
tk.Frame(sidebar_container, bg="#D0D0D0", width=1).pack(side="right", fill="y")
content_frame = tk.Frame(window, bg="white");
content_frame.pack(side="right", fill="both", expand=True)
content_frame.grid_rowconfigure(0, weight=1);
content_frame.grid_columnconfigure(0, weight=1)

# --- 7. 페이지 1 (환율) ---
exchange_page = tk.Frame(content_frame, bg="white");
exchange_page.grid(row=0, column=0, sticky="nsew")
left_panel = tk.Frame(exchange_page, bg="white");
left_panel.pack(side="left", fill="both", expand=True, padx=28, pady=28)
alert_panel = tk.Frame(exchange_page, bg="white", width=400);
alert_panel.pack(side="left", fill="y", pady=28);
alert_panel.pack_propagate(False)
right_panel = tk.Frame(exchange_page, bg="white", width=430);
right_panel.pack(side="right", fill="y");
right_panel.pack_propagate(False)

# 변환기/그래프
converter_frame = tk.Frame(left_panel, bg="white");
converter_frame.pack(anchor="nw", fill="x")
from_frame, from_widgets = create_currency_frame(converter_frame, from_var);
from_frame.pack(pady=(0, 14), fill="x")
from_flag_label = from_widgets['flag'];
from_country_label = from_widgets['country']
tk.Entry(from_widgets['right'], textvariable=amount_var, font=("맑은 고딕", 28, "bold"), justify="right", relief="flat",
         bg="white").pack(fill="x")
to_frame, to_widgets = create_currency_frame(converter_frame, to_var);
to_frame.pack(pady=7, fill="x")
to_flag_label = to_widgets['flag'];
to_country_label = to_widgets['country']
to_amount_label = tk.Label(to_widgets['right'], text="", font=("맑은 고딕", 28, "bold"), bg="white", anchor="e");
to_amount_label.pack(fill="x")

graph_container = tk.Frame(left_panel, bg="white");
graph_container.pack(fill="both", expand=True, pady=14)
tk.Button(graph_container, text="◀", font=("Arial", 16), command=show_prev_graph, bg="white", relief="flat").pack(
    side="left", fill="y")
graph_content_frame = tk.Frame(graph_container, bg="white");
graph_content_frame.pack(side="left", fill="both", expand=True)
tk.Button(graph_container, text="▶", font=("Arial", 16), command=show_next_graph, bg="white", relief="flat").pack(
    side="right", fill="y")

# 알림
tk.Label(alert_panel, text="환율 알림 설정", font=("맑은 고딕", 18, "bold"), bg="white").pack(anchor="w", pady=(14, 0), padx=10)
tk.Frame(alert_panel, height=2, bg="#E0E0E0").pack(fill="x", pady=5, padx=10)
alert_input = tk.Frame(alert_panel, bg="white");
alert_input.pack(fill="x", padx=10)
tk.OptionMenu(alert_input, alert_currency_var, *graph_currency_codes).pack(side="left")
tk.OptionMenu(alert_input, alert_op_var, ">", "<").pack(side="left", padx=5)
alert_value_entry = tk.Entry(alert_input, font=("맑은 고딕", 14), width=10);
alert_value_entry.pack(side="left", padx=5)
tk.Button(alert_input, text="추가", command=add_alert, bg="#0078D7", fg="white", relief="flat").pack(side="left", padx=10)
alert_list_frame = tk.Frame(alert_panel, bg="white");
alert_list_frame.pack(fill="both", expand=True, padx=10, pady=10)

# 시세표
tk.Label(right_panel, text="주요국 환율", font=("맑은 고딕", 18, "bold"), bg="white").pack(pady=14, anchor="w", padx=14)
rate_canvas = tk.Canvas(right_panel, bg="white", highlightthickness=0)
rate_scroll = tk.Scrollbar(right_panel, orient="vertical", command=rate_canvas.yview)
rate_list_scrollable_frame = tk.Frame(rate_canvas, bg="white")
rate_list_scrollable_frame.bind("<Configure>", lambda e: rate_canvas.configure(scrollregion=rate_canvas.bbox("all")))
rate_canvas.create_window((0, 0), window=rate_list_scrollable_frame, anchor="nw");
rate_canvas.configure(yscrollcommand=rate_scroll.set)
rate_canvas.pack(side="left", fill="both", expand=True);
rate_scroll.pack(side="right", fill="y")

# --- 8. 페이지 2 (환율 포커스 - 계기판 추가됨) ---
focus_page = tk.Frame(content_frame, bg="white");
focus_page.grid(row=0, column=0, sticky="nsew")

# 상단 요약
ai_summary_frame = tk.Frame(focus_page, bg="white");
ai_summary_frame.pack(side="top", fill="x", padx=28, pady=(28, 10))
tk.Label(ai_summary_frame, text="AI 환율 동향 요약 (헤드라인)", font=("맑은 고딕", 18, "bold"), bg="white").pack(anchor="w")
tk.Frame(ai_summary_frame, height=2, bg="#E0E0E0").pack(fill="x", pady=5)
ai_summary_label = tk.Label(ai_summary_frame, text="로딩 중...", font=("맑은 고딕", 12), bg="white", justify="left",
                            wraplength=1000);
ai_summary_label.pack(fill="x")

# 중단 AI 예측 (계기판 UI 추가)
prediction_frame = tk.Frame(focus_page, bg="#F9F9F9", highlightthickness=1, highlightbackground="#E0E0E0")
prediction_frame.pack(side="top", fill="x", padx=28, pady=10)

# 예측 컨트롤
pred_ctrl_frame = tk.Frame(prediction_frame, bg="#F9F9F9");
pred_ctrl_frame.pack(fill="x", padx=14, pady=10)
tk.Label(pred_ctrl_frame, text="AI 환율 예측 분석 & 시장 심리", font=("맑은 고딕", 16, "bold"), bg="#F9F9F9", fg="#0078D7").pack(
    side="left")
tk.Label(pred_ctrl_frame, text="  대상:", font=("맑은 고딕", 12), bg="#F9F9F9").pack(side="left", padx=(20, 5))
pred_dropdown = tk.OptionMenu(pred_ctrl_frame, prediction_currency_var, *currency_codes)
pred_dropdown.config(bg="white", relief="flat", font=("맑은 고딕", 11));
pred_dropdown.pack(side="left")
predict_button = tk.Button(pred_ctrl_frame, text="AI 예측 실행", font=("맑은 고딕", 12, "bold"), bg="#0078D7", fg="white",
                           relief="flat",
                           command=lambda: threading.Thread(target=run_prediction_thread, daemon=True).start())
predict_button.pack(side="left", padx=14)

# 예측 결과 (좌측 텍스트 / 우측 계기판)
pred_content_frame = tk.Frame(prediction_frame, bg="white");
pred_content_frame.pack(fill="x", padx=14, pady=(0, 14))
prediction_result_text = scrolledtext.ScrolledText(pred_content_frame, height=9, width=70, font=("맑은 고딕", 11),
                                                   state=tk.DISABLED, bg="white", relief="flat", highlightthickness=1,
                                                   highlightbackground="#E0E0E0")
prediction_result_text.pack(side="left", fill="both", expand=True, padx=(0, 10))

# 계기판 캔버스 (신규) - 초기 높이 160이지만 draw_gauge에서 220으로 자동 조절됨
gauge_canvas = tk.Canvas(pred_content_frame, width=300, height=160, bg="white", highlightthickness=0)
gauge_canvas.pack(side="right")
draw_gauge(gauge_canvas, 50)  # 초기 상태: 50점(중립)

# 하단 뉴스 목록
news_list_container = tk.Frame(focus_page, bg="white");
news_list_container.pack(side="top", fill="both", expand=True, padx=28, pady=10)
total_count_label = tk.Label(news_list_container, text="총 0 건", font=("맑은 고딕", 12), bg="white", anchor="w");
total_count_label.pack(fill="x")
news_list_canvas_frame = tk.Frame(news_list_container, bg="white");
news_list_canvas_frame.pack(fill="both", expand=True)
focus_canvas = tk.Canvas(news_list_canvas_frame, bg="white", highlightthickness=0)
focus_scrollbar = tk.Scrollbar(news_list_canvas_frame, orient="vertical", command=focus_canvas.yview)
focus_scrollable_frame = tk.Frame(focus_canvas, bg="white")
focus_scrollable_frame.bind("<Configure>", lambda e: focus_canvas.configure(scrollregion=focus_canvas.bbox("all")))
focus_canvas.create_window((0, 0), window=focus_scrollable_frame, anchor="nw");
focus_canvas.configure(yscrollcommand=focus_scrollbar.set)
focus_canvas.pack(side="left", fill="both", expand=True);
focus_scrollbar.pack(side="right", fill="y")

news_nav_frame = tk.Frame(focus_page, bg="white");
news_nav_frame.pack(side="bottom", fill="x", padx=28, pady=20)
prev_news_button = tk.Button(news_nav_frame, text="◀ 이전", command=show_prev_news_page, state=tk.DISABLED, bg="white",
                             relief="flat");
prev_news_button.pack(side="left")
page_info_label = tk.Label(news_nav_frame, text="1 / 1", bg="white");
page_info_label.pack(side="left", expand=True)
next_news_button = tk.Button(news_nav_frame, text="다음 ▶", command=show_next_news_page, state=tk.DISABLED, bg="white",
                             relief="flat");
next_news_button.pack(side="right")

# --- 9. 메뉴 & 시작 ---
menu_items = {}


def create_menu_btn(name, text, page):
    f = tk.Frame(sidebar_frame, bg="#F5F5F5");
    f.pack(pady=7, padx=14, fill="x")
    b = tk.Button(f, text=text, font=("맑은 고딕", 16, "bold"), relief="flat", bg="#F5F5F5",
                  command=lambda: show_page(name));
    b.pack()
    u = tk.Frame(f, height=2, bg="black");
    menu_items[name] = {'button': b, 'underline': u, 'page': page}


create_menu_btn('exchange', '환율', exchange_page);
create_menu_btn('focus', '환율 포커스', focus_page)
amount_var.trace("w", update_conversion_display);
from_var.trace("w", update_all_displays);
to_var.trace("w", update_all_displays)

show_page("exchange");
periodic_update();
window.mainloop()
