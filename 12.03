# --- ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸ ---
import tkinter as tk
from tkinter import messagebox, scrolledtext, ttk
import requests
from bs4 import BeautifulSoup
import webbrowser
import threading
import math
from PIL import Image, ImageTk
from datetime import datetime, timedelta
import matplotlib

matplotlib.rcParams['font.family'] = 'Malgun Gothic'
matplotlib.use("TkAgg")
from matplotlib.figure import Figure
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import matplotlib.dates as mdates


# --- [ì‹ ê·œ ê¸°ëŠ¥] ìˆ«ì -> í•œê¸€ ë‹¨ìœ„ ë³€í™˜ í•¨ìˆ˜ ---
def format_korean_number(number_str, symbol):
    """
    ìˆ«ì ë¬¸ìì—´(ì˜ˆ: '12345678')ì„ ë°›ì•„ì„œ
    í•œêµ­ì‹ ë‹¨ìœ„(ì˜ˆ: '1,234ë§Œ 5,678 ë‹¬ëŸ¬')ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
    """
    try:
        if not number_str: return ""
        clean_str = number_str.replace(',', '')
        val = float(clean_str)

        sign = "-" if val < 0 else ""
        abs_val = abs(val)
        int_part = int(abs_val)

        # ì†Œìˆ˜ì  ì²˜ë¦¬ (ìµœëŒ€ 2ìë¦¬)
        decimal_part = ""
        if '.' in clean_str:
            decimal_part = "." + clean_str.split('.')[1][:2]

        if int_part == 0:
            return f"{sign}0{decimal_part} {symbol}"

        # 4ìë¦¬(ë§Œ ë‹¨ìœ„)ì”© ëŠì–´ì„œ ì²˜ë¦¬
        units = ["", "ë§Œ", "ì–µ", "ì¡°", "ê²½", "í•´"]
        parts = []
        temp = int_part
        unit_idx = 0

        while temp > 0:
            rem = temp % 10000
            if rem > 0:
                # ê° ë‹¨ìœ„ ì•ˆì—ì„œë„ ì½¤ë§ˆ í¬ë§·íŒ… (ì˜ˆ: 5,392)
                parts.append(f"{rem:,}{units[unit_idx]}")
            temp //= 10000
            unit_idx += 1

        parts.reverse()
        result_str = f"{sign}{' '.join(parts)}{decimal_part} {symbol}"
        return result_str
    except:
        return ""


# --- 1. ëª¨ë“  í•¨ìˆ˜ ì •ì˜ ---

def check_alerts():
    if not exchange_rates: return
    triggered_alerts = []
    for alert in list(user_alerts):
        try:
            current_rate = 1 / exchange_rates.get(alert['code'], 0)
            if current_rate == 0: continue
            condition_met = False
            if alert['op'] == '>' and current_rate > alert['value']:
                condition_met = True
            elif alert['op'] == '<' and current_rate < alert['value']:
                condition_met = True
            if condition_met:
                msg = f"í™˜ìœ¨ ì•Œë¦¼!\n\n{alert['code']} í™˜ìœ¨ì´ ì„¤ì •í•˜ì‹  {alert['value']}ì› {alert['op']} ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.\n\ní˜„ì¬ í™˜ìœ¨: {current_rate:,.2f}ì›"
                messagebox.showinfo("í™˜ìœ¨ ë³€ë™ ì•Œë¦¼", msg)
                triggered_alerts.append(alert)
        except Exception as e:
            print(f"ì•Œë¦¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜: {e}")
    for alert in triggered_alerts:
        if alert in user_alerts: user_alerts.remove(alert)
    if exchange_page.winfo_viewable(): update_alert_list_ui()


def add_alert():
    code = alert_currency_var.get();
    op = alert_op_var.get();
    value_str = alert_value_entry.get()
    try:
        value = float(value_str)
        if value <= 0: raise ValueError
    except ValueError:
        messagebox.showwarning("ì…ë ¥ ì˜¤ë¥˜", "ëª©í‘œ í™˜ìœ¨ì€ 0ë³´ë‹¤ í° ìˆ«ìë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
        return
    new_alert = {'code': code, 'op': op, 'value': value}
    user_alerts.append(new_alert)
    alert_value_entry.delete(0, tk.END)
    update_alert_list_ui()


def remove_alert(alert_to_remove):
    global user_alerts;
    user_alerts = [alert for alert in user_alerts if alert != alert_to_remove]
    update_alert_list_ui()


def update_alert_list_ui():
    if 'alert_list_frame' in globals():
        for widget in alert_list_frame.winfo_children(): widget.destroy()
        if not user_alerts:
            tk.Label(alert_list_frame, text="í˜„ì¬ ì„¤ì •ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.", font=("ë§‘ì€ ê³ ë”•", 12), bg="white", fg="gray").pack(pady=5)
        else:
            for alert in user_alerts:
                alert_frame = tk.Frame(alert_list_frame, bg="#F0F0F0")
                alert_text = f"{alert['code']} í™˜ìœ¨ì´ {alert['value']}ì› {alert['op']} ì¼ ë•Œ ì•Œë¦¼"
                tk.Label(alert_frame, text=alert_text, font=("ë§‘ì€ ê³ ë”•", 11), bg="#F0F0F0", fg="black").pack(side="left",
                                                                                                          padx=10,
                                                                                                          pady=5)
                tk.Button(alert_frame, text="X", font=("Arial", 10, "bold"), fg="red", relief="flat", bg="#F0F0F0",
                          command=lambda a=alert: remove_alert(a)).pack(side="right", padx=5)
                alert_frame.pack(fill="x", pady=2)


def get_gemini_response(system_prompt, user_prompt):
    api_key = "AIzaSyB-9d7FWVda1fomaygsZN-AGlRMqlgwIMk"  # âš ï¸ API í‚¤
    if not api_key: return "ì˜¤ë¥˜: API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    api_url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key={api_key}"
    payload = {"contents": [{"parts": [{"text": user_prompt}]}],
               "systemInstruction": {"parts": [{"text": system_prompt}]}}
    try:
        response = requests.post(api_url, json=payload, headers={'Content-Type': 'application/json'}, timeout=30)
        response.raise_for_status();
        result = response.json()
        return result['candidates'][0]['content']['parts'][0]['text']
    except Exception as e:
        return f"ì˜¤ë¥˜ ë°œìƒ: {e}"


def get_ai_summary(headlines):
    system_prompt = "ë‹¹ì‹ ì€ ì™¸í™˜ ì‹œì¥ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ë‰´ìŠ¤ í—¤ë“œë¼ì¸ì„ ë°”íƒ•ìœ¼ë¡œ ì›í™”(KRW) í™˜ìœ¨ ì‹œì¥ì˜ ì£¼ìš” ì´ìŠˆë¥¼ í•œêµ­ì–´ë¡œ 3ì¤„ ì´ë‚´ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”."
    headlines_text = "\n".join([f"- {h['title']}" for h in headlines])
    user_prompt = f"ìµœì‹  í™˜ìœ¨ ë‰´ìŠ¤:\n{headlines_text}\n\nìœ„ ë‚´ìš©ì„ ìš”ì•½í•´ ì£¼ì„¸ìš”."
    return get_gemini_response(system_prompt, user_prompt)


def update_ai_summary_thread(headlines):
    try:
        summary_text = get_ai_summary(headlines)
        window.after(0, lambda: ai_summary_label.config(text=summary_text))
    except Exception as e:
        print(f"AI ìš”ì•½ ìŠ¤ë ˆë“œ ì˜¤ë¥˜: {e}")
        window.after(0, lambda: ai_summary_label.config(text="AI ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."))


def get_ai_prediction_with_score(target_code, headlines):
    target_name = currency_data.get(target_code, {}).get('name', target_code)
    system_prompt = (f"ë‹¹ì‹ ì€ {target_name}({target_code}) í™˜ìœ¨ ì˜ˆì¸¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. "
                     f"ë‰´ìŠ¤ í—¤ë“œë¼ì¸ì„ ë¶„ì„í•˜ì—¬ í–¥í›„ ì¼ì£¼ì¼ê°„ì˜ ì¶”ì„¸ë¥¼ ì˜ˆì¸¡í•˜ì„¸ìš”. "
                     "ë°˜ë“œì‹œ ë‹¤ìŒ í˜•ì‹ì„ ì§€ì¼œ ë‹µë³€í•˜ì„¸ìš”:\n"
                     "1. ì˜ˆì¸¡: [ìƒìŠ¹ / í•˜ë½ / ë³´í•©] ì¤‘ íƒ1\n"
                     "2. ë¶„ì„: 3ë¬¸ì¥ ë‚´ì™¸ ì„¤ëª…\n"
                     "3. ì¡°ì–¸: í•œ ì¤„ íˆ¬ì ì¡°ì–¸\n"
                     "4. SCORE: 0~100 ì‚¬ì´ì˜ ì •ìˆ˜ (0=í­ë½ì˜ˆìƒ, 50=ë³€ë™ì—†ìŒ, 100=í­ë“±ì˜ˆìƒ). "
                     "ë§ˆì§€ë§‰ ì¤„ì€ ë°˜ë“œì‹œ 'SCORE: 75' ì²˜ëŸ¼ ì ìˆ˜ë§Œ ì ìœ¼ì„¸ìš”.")
    headlines_text = "\n".join([f"- {h['title']}" for h in headlines]) or "(ë‰´ìŠ¤ ì—†ìŒ)"
    user_prompt = f"ë¶„ì„ ëŒ€ìƒ: {target_name} {target_code}\nì°¸ê³  ë‰´ìŠ¤:\n{headlines_text}\n\ní™˜ìœ¨ ì¶”ì„¸ë¥¼ ì˜ˆì¸¡í•´ ì£¼ì„¸ìš”."
    return get_gemini_response(system_prompt, user_prompt)


def run_prediction_thread():
    target_code = prediction_currency_var.get()
    if not target_code: return
    predict_button.config(state=tk.DISABLED, text="ë¶„ì„ ì¤‘...", bg="gray")
    prediction_result_text.config(state=tk.NORMAL);
    prediction_result_text.delete("1.0", tk.END)
    prediction_result_text.insert(tk.END, f"AIê°€ {target_code} ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...\n\n(ê³„ê¸°íŒì„ ì¤€ë¹„í•˜ëŠ” ì¤‘...)")
    prediction_result_text.config(state=tk.DISABLED)
    headlines, _ = get_news_headlines(current_news_page)
    full_text = get_ai_prediction_with_score(target_code, headlines)
    score = 50
    clean_text = full_text
    try:
        lines = full_text.strip().split('\n')
        last_line = lines[-1].strip()
        if "SCORE:" in last_line:
            score_part = last_line.split("SCORE:")[1].strip()
            score = int(float(score_part))
            clean_text = "\n".join(lines[:-1]).strip()
    except Exception as e:
        print(f"ì ìˆ˜ íŒŒì‹± ì‹¤íŒ¨: {e}")
    window.after(0, lambda: update_prediction_ui(clean_text, score))


def update_prediction_ui(result_text, score):
    prediction_result_text.config(state=tk.NORMAL)
    prediction_result_text.delete("1.0", tk.END)
    prediction_result_text.insert(tk.END, result_text)
    prediction_result_text.config(state=tk.DISABLED)
    draw_gauge(gauge_canvas, score)
    predict_button.config(state=tk.NORMAL, text="AI ì˜ˆì¸¡ ì‹¤í–‰", bg="#0078D7")


def get_naver_exchange_rate(code):
    try:
        url = "https://finance.naver.com/marketindex/"
        response = requests.get(url, timeout=5)
        soup = BeautifulSoup(response.text, "html.parser")
        if code == 'USD':
            value = soup.select_one("#exchangeList > li.on > a.head.usd > div > span.value").text
            return float(value.replace(',', ''))
        elif code == 'JPY':
            value = soup.select_one("#exchangeList > li > a.head.jpy > div > span.value").text
            return float(value.replace(',', ''))
        elif code == 'EUR':
            value = soup.select_one("#exchangeList > li > a.head.eur > div > span.value").text
            return float(value.replace(',', ''))
        return 1 / exchange_rates.get(code, 0.001)
    except Exception as e:
        print(f"í¬ë¡¤ë§ ì‹¤íŒ¨ ({code}): {e}")
        return 1 / exchange_rates.get(code, 0.001)


def calculate_fees_and_recommend():
    code = fee_currency_var.get()
    try:
        krw_amount = float(fee_amount_entry.get().replace(',', ''))
    except ValueError:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "í™˜ì „í•  ì›í™”(KRW) ê¸ˆì•¡ì„ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return
    base_rate = get_naver_exchange_rate(code)
    spread_rate = 0.0175
    if code not in ['USD', 'JPY', 'EUR']: spread_rate = 0.035

    calc = lambda rate, spread, pref: krw_amount / (rate + (rate * spread * (1 - pref)))
    get_money_app = calc(base_rate, spread_rate, 0.90)
    get_money_bank = calc(base_rate, spread_rate, 0.50)
    get_money_airport = calc(base_rate, 0.04, 0.0)

    for item in fee_tree.get_children(): fee_tree.delete(item)
    unit = code
    fee_tree.insert("", "end", values=("ìŠ¤ë§ˆíŠ¸í° ì•± (90% ìš°ëŒ€)", f"~ {get_money_app:,.2f} {unit}", "ìµœëŒ€ ìˆ˜ë ¹ (ì¶”ì²œ) ğŸ‘"))
    fee_tree.insert("", "end", values=("ì€í–‰ ì°½êµ¬ (50% ìš°ëŒ€)", f"~ {get_money_bank:,.2f} {unit}",
                                       f"-{get_money_app - get_money_bank:,.2f} {unit} ì†í•´"))
    fee_tree.insert("", "end", values=("ì¸ì²œê³µí•­ (ìš°ëŒ€ ì—†ìŒ)", f"~ {get_money_airport:,.2f} {unit}",
                                       f"-{get_money_app - get_money_airport:,.2f} {unit} ì†í•´ ğŸ˜±"))

    fee_result_text.config(state=tk.NORMAL)
    fee_result_text.delete("1.0", tk.END)
    fee_result_text.insert(tk.END, f"AIê°€ {code} í™˜ì „ íŒì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...\n")
    fee_result_text.config(state=tk.DISABLED)
    threading.Thread(target=run_fee_recommendation_ai,
                     args=(code, krw_amount, base_rate, get_money_app, get_money_airport), daemon=True).start()


def run_fee_recommendation_ai(code, krw_amount, base_rate, app_get, airport_get):
    diff = app_get - airport_get
    system_prompt = "ë‹¹ì‹ ì€ ê¹ê¹í•œ ê¸ˆìœµ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í™˜ì „ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ëˆì„ ì•„ë¼ëŠ” ë°©ë²•ì„ ì§ì„¤ì ìœ¼ë¡œ ì¡°ì–¸í•´ ì£¼ì„¸ìš”."
    user_prompt = (f"ì‚¬ìš©ìê°€ {krw_amount:,.0f}ì›ì„ {code}ë¡œ í™˜ì „í•˜ë ¤ í•©ë‹ˆë‹¤.\n"
                   f"ì°¨ì´: {diff:,.2f} {code} ë” ë°›ìŒ\n\n"
                   "1. ì•± í™˜ì „ ì¶”ì²œ ì´ìœ \n2. ì°¨ì•¡ìœ¼ë¡œ í˜„ì§€ì—ì„œ í•  ìˆ˜ ìˆëŠ” ê²ƒ ì˜ˆì‹œ\n3. ì¶”ì²œ ì€í–‰ ì•± ì–¸ê¸‰")
    response = get_gemini_response(system_prompt, user_prompt)
    window.after(0, lambda: update_fee_ai_ui(response))


def update_fee_ai_ui(text):
    fee_result_text.config(state=tk.NORMAL)
    fee_result_text.delete("1.0", tk.END)
    fee_result_text.insert(tk.END, text)
    fee_result_text.config(state=tk.DISABLED)


def draw_gauge(canvas, score):
    canvas.config(height=220)
    canvas.delete("all")
    w = 300;
    cx = w / 2;
    cy = 150;
    radius = 110
    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius, start=0, extent=180, outline="#F0F0F0",
                      width=30, style="arc")
    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius, start=120, extent=60, outline="#0078D7",
                      width=25, style="arc")
    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius, start=60, extent=60, outline="gray", width=25,
                      style="arc")
    canvas.create_arc(cx - radius, cy - radius, cx + radius, cy + radius, start=0, extent=60, outline="#FF3B30",
                      width=25, style="arc")

    text_r = radius + 25
    canvas.create_text(cx + text_r * math.cos(math.radians(150)), cy - text_r * math.sin(math.radians(150)), text="í•˜ë½",
                       font=("ë§‘ì€ ê³ ë”•", 11, "bold"), fill="#0078D7")
    canvas.create_text(cx + text_r * math.cos(math.radians(90)), cy - text_r * math.sin(math.radians(90)), text="ë³´í•©",
                       font=("ë§‘ì€ ê³ ë”•", 11, "bold"), fill="gray")
    canvas.create_text(cx + text_r * math.cos(math.radians(30)), cy - text_r * math.sin(math.radians(30)), text="ìƒìŠ¹",
                       font=("ë§‘ì€ ê³ ë”•", 11, "bold"), fill="#FF3B30")

    angle = 180 - (score * 1.8)
    angle_rad = math.radians(angle)
    needle_len = radius - 10
    nx = cx + needle_len * math.cos(angle_rad)
    ny = cy - needle_len * math.sin(angle_rad)
    canvas.create_line(cx, cy, nx, ny, width=4, fill="black", arrow=tk.LAST, arrowshape=(10, 12, 5))
    canvas.create_oval(cx - 5, cy - 5, cx + 5, cy + 5, fill="black")
    color = "#FF3B30" if score > 60 else "#0078D7" if score < 40 else "gray"
    canvas.create_text(cx, cy + 40, text=f"ì‹¬ë¦¬ ì§€ìˆ˜: {score}", font=("ë§‘ì€ ê³ ë”•", 16, "bold"), fill=color)


def get_news_headlines(page_num=1):
    url = f"https://www.kita.net/cmmrcInfo/ehgtNews/ehgtNewsList.do?pageIndex={page_num}"
    news_list = [];
    total_news_count = 0
    try:
        response = requests.get(url, timeout=10);
        response.raise_for_status()
        soup = BeautifulSoup(response.text, "html.parser")
        summary_div = soup.find("div", class_="bbs-summary");
        if summary_div and summary_div.find("strong"):
            try:
                total_news_count = int(summary_div.find("strong").text.replace(',', ''))
            except ValueError:
                pass
        news_ul = soup.find("ul", class_="board-list");
        if not news_ul: return [], 0
        for item in news_ul.find_all("li"):
            subject_div = item.find("div", class_="subject");
            info_div = item.find("div", class_="info");
            date_text = ""
            if info_div:
                date_span = info_div.find("span", class_="date")
                if date_span: date_text = date_span.text.strip()
            if subject_div:
                link_tag = subject_div.find("a")
                if link_tag and link_tag.has_attr('onclick'):
                    onclick_attr = link_tag['onclick']
                    try:
                        params = onclick_attr.split('(')[1].split(')')[0].replace("'", "").split(',')
                        link = f"https://www.kita.net/cmmrcInfo/ehgtNews/ehgtNewsDetail.do?classification={params[0].strip()}&no={params[1].strip()}"
                        title = link_tag.text.strip()
                        if title: news_list.append({'title': title, 'link': link, 'date': date_text})
                    except:
                        pass
    except Exception as e:
        print(f"ë‰´ìŠ¤ íŒŒì‹± ì˜¤ë¥˜: {e}")
    return news_list[:15], total_news_count


def open_news_link(url):
    try:
        webbrowser.open(url, new=2)
    except:
        pass


def on_news_enter(e, label): label.config(font=("ë§‘ì€ ê³ ë”•", 14, "bold"), fg="#1E90FF")


def on_news_leave(e, label): label.config(font=("ë§‘ì€ ê³ ë”•", 13), fg="black")


def populate_focus_page(page_num=1):
    for widget in focus_scrollable_frame.winfo_children(): widget.destroy()
    global current_news_page, total_news_pages;
    current_news_page = page_num
    if page_num == 1:
        ai_summary_label.config(text="AIê°€ ìµœì‹  ë‰´ìŠ¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...")
    else:
        ai_summary_label.config(text="AI ìš”ì•½ì€ ì²« í˜ì´ì§€ë§Œ ì§€ì›ë©ë‹ˆë‹¤.")
    news_headlines, total_count = get_news_headlines(page_num)
    total_news_pages = (total_count + 9) // 10 if total_count > 0 else 1
    total_count_label.config(text=f"ì´ {total_count:,} ê±´")
    if not news_headlines: tk.Label(focus_scrollable_frame, text="ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", font=("ë§‘ì€ ê³ ë”•", 16)).pack(
        pady=28); return
    for i, news in enumerate(news_headlines):
        item_frame = tk.Frame(focus_scrollable_frame, bg="white", height=60);
        item_frame.pack(fill="x");
        item_frame.pack_propagate(False)
        item_frame.grid_columnconfigure(0, weight=1)
        title_lbl = tk.Label(item_frame, text=news['title'], font=("ë§‘ì€ ê³ ë”•", 13), bg="white", anchor="w", cursor="hand2")
        title_lbl.grid(row=0, column=0, sticky="nsew", padx=14)
        date_lbl = tk.Label(item_frame, text=news['date'], font=("ë§‘ì€ ê³ ë”•", 12), fg="gray", bg="white", anchor="e")
        date_lbl.grid(row=0, column=1, sticky="nsew", padx=14)
        title_lbl.bind("<Button-1>", lambda e, u=news['link']: open_news_link(u))
        title_lbl.bind("<Enter>", lambda e, l=title_lbl: on_news_enter(e, l))
        title_lbl.bind("<Leave>", lambda e, l=title_lbl: on_news_leave(e, l))
        if i < len(news_headlines) - 1: tk.Frame(focus_scrollable_frame, height=1, bg="#F0F0F0").pack(fill="x")
    page_info_label.config(text=f"í˜ì´ì§€ {current_news_page} / {total_news_pages}")
    prev_news_button.config(state=tk.NORMAL if current_news_page > 1 else tk.DISABLED)
    next_news_button.config(state=tk.NORMAL if current_news_page < total_news_pages else tk.DISABLED)
    if page_num == 1 and news_headlines: threading.Thread(target=update_ai_summary_thread, args=(news_headlines,),
                                                          daemon=True).start()


def show_next_news_page():
    if current_news_page < total_news_pages: populate_focus_page(current_news_page + 1)


def show_prev_news_page():
    if current_news_page > 1: populate_focus_page(current_news_page - 1)


def fetch_all_data_and_check_alerts():
    try:
        url_today = "https://open.er-api.com/v6/latest/KRW"
        data_today = requests.get(url_today, timeout=10).json()
        if data_today.get("result") == "success":
            global exchange_rates;
            exchange_rates = data_today["rates"]
            yesterday = datetime.now() - timedelta(days=1);
            date_str = yesterday.strftime('%Y-%m-%d')
            url_yest = f"https://api.frankfurter.app/{date_str}?from=KRW"
            data_yest = requests.get(url_yest, timeout=10).json()
            if 'rates' in data_yest:
                global yesterday_exchange_rates
                yesterday_exchange_rates = {code: 1 / rate for code, rate in data_yest.get('rates', {}).items() if
                                            rate != 0}
                yesterday_exchange_rates['KRW'] = 1.0
            window.after(0, update_ui_and_check_alerts)
    except Exception as e:
        print(f"ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: {e}")
    finally:
        window.after(ALERT_CHECK_INTERVAL, periodic_update)


def periodic_update(): threading.Thread(target=fetch_all_data_and_check_alerts, daemon=True).start()


def update_ui_and_check_alerts():
    if exchange_page.winfo_viewable():
        update_all_displays();
        populate_rate_list();
        update_alert_list_ui()
    check_alerts()


def populate_rate_list():
    if 'rate_list_scrollable_frame' not in globals(): return
    for widget in rate_list_scrollable_frame.winfo_children(): widget.destroy()
    if not exchange_rates: return
    focus_currencies = ['USD', 'JPY', 'EUR', 'CNY', 'GBP', 'AUD', 'CAD', 'CHF']
    for code in focus_currencies:
        if code not in exchange_rates: continue
        today_rate = 1 / exchange_rates[code]
        row = tk.Frame(rate_list_scrollable_frame, bg="white");
        row.pack(fill="x", pady=7, padx=14)
        tk.Label(row, image=tk_flag_images.get(f"{code}_small"), bg="white").pack(side="left", padx=(0, 10))
        tk.Label(row, text=f"{currency_data[code]['name']} {code}", font=("ë§‘ì€ ê³ ë”•", 14, "bold"), bg="white", width=12,
                 anchor="w").pack(side="left")
        yesterday_rate = yesterday_exchange_rates.get(code, today_rate);
        change = today_rate - yesterday_rate
        color = "red" if change >= 0 else "blue";
        symbol = "â–²" if change >= 0 else "â–¼"
        tk.Label(row, text=f"{symbol} {abs(change):.2f}", font=("ë§‘ì€ ê³ ë”•", 12), fg=color, bg="white").pack(side="right")
        tk.Label(row, text=f"{today_rate:,.2f}", font=("ë§‘ì€ ê³ ë”•", 14, "bold"), bg="white").pack(side="right", padx=10)
        tk.Frame(rate_list_scrollable_frame, height=1, bg="#F0F0F0").pack(fill="x", padx=14)


def get_historical_data(base, target="KRW", days=30):
    today = datetime.now();
    start = (today - timedelta(days=days)).strftime('%Y-%m-%d')
    url = f"https://api.frankfurter.app/{start}..?from={base}&to={target}"
    try:
        data = requests.get(url, timeout=10).json()
        if 'rates' in data:
            dates = sorted(data['rates'].keys())
            rates = [data['rates'][d][target] for d in dates]
            dates_dt = [datetime.strptime(d, '%Y-%m-%d') for d in dates]
            if dates_dt and dates_dt[-1].date() != today.date() and (base in exchange_rates):
                dates_dt.append(today);
                rates.append(1 / exchange_rates[base])
            return dates_dt, rates
    except:
        pass
    return None, None


def draw_graph(dates, rates, base_code):
    if 'graph_content_frame' not in globals(): return
    for widget in graph_content_frame.winfo_children(): widget.destroy()
    if not dates or not rates: tk.Label(graph_content_frame, text="ë°ì´í„° ë¶€ì¡±", font=("ë§‘ì€ ê³ ë”•", 18), bg="white").pack(
        expand=True); return
    header = tk.Frame(graph_content_frame, bg="white");
    header.pack(fill="x", padx=12, pady=(12, 0))
    if tk_flag_images.get(base_code): tk.Label(header, image=tk_flag_images.get(base_code), bg="white").pack(
        side="left")
    tk.Label(header, text=f"{currency_data[base_code]['name']} {base_code}", font=("ë§‘ì€ ê³ ë”•", 14, "bold"),
             bg="white").pack(side="left", padx=(6, 12))
    curr = rates[-1];
    prev = rates[-2] if len(rates) > 1 else curr;
    change = curr - prev;
    pct = (change / prev) * 100 if prev else 0
    tk.Label(header, text=f"{curr:,.2f}", font=("ë§‘ì€ ê³ ë”•", 24, "bold"), bg="white").pack(side="left")
    color = "red" if change >= 0 else "blue";
    symb = "â–²" if change >= 0 else "â–¼"
    tk.Label(header, text=f"{symb} {change:,.2f} ({pct:.2f}%)", font=("ë§‘ì€ ê³ ë”•", 12), bg="white", fg=color).pack(
        side="left", pady=(6, 0))

    btns = tk.Frame(graph_content_frame, bg="white");
    btns.pack(fill="x", padx=12, pady=(6, 0))
    for t, d in [("1ê°œì›”", 30), ("3ê°œì›”", 90), ("1ë…„", 365)]:
        tk.Button(btns, text=t, font=("ë§‘ì€ ê³ ë”•", 11), relief="flat", bg="white",
                  command=lambda x=d: update_chart_by_period(x)).pack(side="left", padx=4)

    fig = Figure(figsize=(6, 3.6), dpi=100, facecolor="white");
    ax = fig.add_subplot(111)
    ax.plot(dates, rates, color='royalblue', linewidth=1.8);
    ax.fill_between(dates, rates, color='royalblue', alpha=0.1)
    mx = max(rates);
    mn = min(rates);
    ax.set_ylim(mn - (mx - mn) * 0.1, mx + (mx - mn) * 0.1)
    ax.set_facecolor("white");
    ax.spines['top'].set_visible(False);
    ax.spines['right'].set_visible(False)
    ax.xaxis.set_major_formatter(mdates.DateFormatter('%m-%d'));
    fig.tight_layout()
    canvas = FigureCanvasTkAgg(fig, master=graph_content_frame);
    canvas.draw();
    canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True, padx=12, pady=(0, 12))


def update_chart_by_period(days=30):
    base = graph_currency_codes[current_graph_index];
    dates, rates = get_historical_data(base, 'KRW', days);
    draw_graph(dates, rates, base)


def show_next_graph(): global current_graph_index; current_graph_index = (
                                                                                     current_graph_index + 1) % 4; update_chart_by_period(
    30)


def show_prev_graph(): global current_graph_index; current_graph_index = (
                                                                                     current_graph_index - 1 + 4) % 4; update_chart_by_period(
    30)


# --- [ìˆ˜ì •] í•œê¸€ ë‹¨ìœ„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë¡œì§ ì¶”ê°€ ---
def update_conversion_display(*args):
    try:
        input_str = amount_var.get()
        if not input_str:
            from_amount_sub_label.config(text="")
            to_amount_sub_label.config(text="")
            to_amount_label.config(text="0")
            return

        amt = float(input_str.replace(',', ''))
        f, t = from_var.get(), to_var.get()
        fr, tr = exchange_rates.get(f, 0), exchange_rates.get(t, 0)

        if fr:
            converted = (amt / fr) * tr
            to_amount_label.config(text=f"{converted:,.2f}")

            # êµ­ê¸°/ë‚˜ë¼ ì´ë¦„ ì—…ë°ì´íŠ¸
            from_flag_label.config(image=tk_flag_images.get(f));
            to_flag_label.config(image=tk_flag_images.get(t))
            from_country_label.config(text=currency_data[f]['name']);
            to_country_label.config(text=currency_data[t]['name'])

            # [ì‹ ê·œ] í•œê¸€ ë‹¨ìœ„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            f_symbol = currency_data[f]['symbol']
            t_symbol = currency_data[t]['symbol']

            korean_from = format_korean_number(input_str, f_symbol)
            korean_to = format_korean_number(str(converted), t_symbol)

            from_amount_sub_label.config(text=korean_from)
            to_amount_sub_label.config(text=korean_to)

    except:
        pass


def update_all_displays(*args):
    update_conversion_display()
    if from_var.get() in graph_currency_codes:
        global current_graph_index;
        current_graph_index = graph_currency_codes.index(from_var.get());
        update_chart_by_period(30)


def show_page(page_name):
    for name, items in menu_items.items():
        if name == page_name:
            items['button'].config(fg="black", bg="#F5F5F5");
            items['underline'].pack(fill="x", padx=14, pady=(0, 7));
            items['page'].tkraise()
        else:
            items['button'].config(fg="gray", bg="#F5F5F5");
            items['underline'].pack_forget()
    if page_name == "focus":
        populate_focus_page(1)
    elif page_name == "exchange":
        populate_rate_list(); update_alert_list_ui()


# --- [ìˆ˜ì •] UI í”„ë ˆì„ì— ì„œë¸Œ ë¼ë²¨(íšŒìƒ‰ ê¸€ì”¨) ì¶”ê°€ ---
def create_currency_frame(parent, tk_var):
    frame = tk.Frame(parent, bg="white", highlightbackground="#E0E0E0", highlightthickness=1)

    # ì™¼ìª½ (êµ­ê¸°, í†µí™”ì½”ë“œ ì„ íƒ)
    left = tk.Frame(frame, bg="white", width=216, height=172);
    left.pack(side="left", padx=14, pady=14);
    left.pack_propagate(False)
    tk.Label(left, text="", bg="white").grid(row=0, column=0)
    tk.Label(left, text="", bg="white", font=("ë§‘ì€ ê³ ë”•", 16, "bold")).grid(row=1, column=0)
    tk.OptionMenu(left, tk_var, *currency_codes).grid(row=3, column=0)

    # êµ¬ë¶„ì„ 
    tk.Frame(frame, bg="#E0E0E0", width=1).pack(side="left", fill="y", pady=14)

    # ì˜¤ë¥¸ìª½ (ìˆ«ì í‘œì‹œ ì˜ì—­)
    right = tk.Frame(frame, bg="white");
    right.pack(side="right", fill="both", expand=True, padx=14, pady=14)

    # [ì‹ ê·œ] ì„œë¸Œ ë¼ë²¨(íšŒìƒ‰ ê¸€ì”¨)ì„ ìœ„í•´ right í”„ë ˆì„ ë‚´ë¶€ì— ë ˆì´ì•„ì›ƒ ì¡ê¸°
    # ìœ„ìª½: í° ìˆ«ì (Entry or Label)
    # ì•„ë˜ìª½: íšŒìƒ‰ ì‘ì€ ê¸€ì”¨ (Label)

    # sub_labelì€ ë‚˜ì¤‘ì— packì„ í•´ì„œ ìœ„ì¹˜ë¥¼ ì¡ì•„ì•¼ í•¨.
    # Entry/Main Labelì€ ì™¸ë¶€ì—ì„œ pack í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” sub_labelë§Œ ìƒì„±í•´ë‘ .
    sub_label = tk.Label(right, text="", font=("ë§‘ì€ ê³ ë”•", 13), fg="gray", bg="white", anchor="e")

    return frame, {'flag': left.winfo_children()[0], 'country': left.winfo_children()[1], 'right': right,
                   'sub_label': sub_label}


# --- 2. ì „ì—­ ë³€ìˆ˜ ---
exchange_rates = {};
yesterday_exchange_rates = {}
currency_data = {
    'USD': {'name': 'ë¯¸êµ­', 'symbol': 'ë‹¬ëŸ¬', 'flag': 'image/us.png'},
    'KRW': {'name': 'ëŒ€í•œë¯¼êµ­', 'symbol': 'ì›', 'flag': 'image/kr.png'},
    'JPY': {'name': 'ì¼ë³¸', 'symbol': 'ì—”', 'flag': 'image/jp.png'},
    'EUR': {'name': 'ìœ ë¡œì¡´', 'symbol': 'ìœ ë¡œ', 'flag': 'image/eur.png'},
    'CNY': {'name': 'ì¤‘êµ­', 'symbol': 'ìœ„ì•ˆ', 'flag': 'image/cn.png'},
    'GBP': {'name': 'ì˜êµ­', 'symbol': 'íŒŒìš´ë“œ', 'flag': 'image/gbp.png'},
    'AUD': {'name': 'í˜¸ì£¼', 'symbol': 'ë‹¬ëŸ¬', 'flag': 'image/aud.png'},
    'CAD': {'name': 'ìºë‚˜ë‹¤', 'symbol': 'ë‹¬ëŸ¬', 'flag': 'image/cad.png'},
    'CHF': {'name': 'ìŠ¤ìœ„ìŠ¤', 'symbol': 'í”„ë‘', 'flag': 'image/chf.png'}
}
currency_codes = list(currency_data.keys());
graph_currency_codes = ['USD', 'JPY', 'EUR', 'CNY']
current_graph_index = 0;
current_news_page = 1;
total_news_pages = 1;
user_alerts = [];
ALERT_CHECK_INTERVAL = 600000

# --- 3. GUI ì„¤ì • ---
window = tk.Tk();
window.title("ì‹¤ì‹œê°„ í™˜ìœ¨ ì •ë³´ & AI ë¶„ì„");
window.geometry("1800x1200");
window.config(bg="white")

# --- 4. ì´ë¯¸ì§€ ---
tk_flag_images = {}
for code, data in currency_data.items():
    try:
        tk_flag_images[code] = ImageTk.PhotoImage(Image.open(data['flag']).resize((58, 37)))
        tk_flag_images[f"{code}_small"] = ImageTk.PhotoImage(Image.open(data['flag']).resize((36, 24)))
    except:
        pass

# --- 5. ë³€ìˆ˜ ---
amount_var = tk.StringVar(value="1");
from_var = tk.StringVar(value='USD');
to_var = tk.StringVar(value='KRW')
alert_currency_var = tk.StringVar(value='USD');
alert_op_var = tk.StringVar(value='>')
prediction_currency_var = tk.StringVar(value='USD')
fee_currency_var = tk.StringVar(value='USD')

# --- 6. ë ˆì´ì•„ì›ƒ ---
sidebar_container = tk.Frame(window);
sidebar_container.pack(side="left", fill="y")
sidebar_frame = tk.Frame(sidebar_container, bg="#F5F5F5", width=216);
sidebar_frame.pack(side="left", fill="y", expand=False);
sidebar_frame.pack_propagate(False)
tk.Frame(sidebar_container, bg="#D0D0D0", width=1).pack(side="right", fill="y")
content_frame = tk.Frame(window, bg="white");
content_frame.pack(side="right", fill="both", expand=True)
content_frame.grid_rowconfigure(0, weight=1);
content_frame.grid_columnconfigure(0, weight=1)

# --- 7. í˜ì´ì§€ 1 (í™˜ìœ¨) ---
exchange_page = tk.Frame(content_frame, bg="white");
exchange_page.grid(row=0, column=0, sticky="nsew")
left_panel = tk.Frame(exchange_page, bg="white");
left_panel.pack(side="left", fill="both", expand=True, padx=28, pady=28)
alert_panel = tk.Frame(exchange_page, bg="white", width=400);
alert_panel.pack(side="left", fill="y", pady=28);
alert_panel.pack_propagate(False)
right_panel = tk.Frame(exchange_page, bg="white", width=430);
right_panel.pack(side="right", fill="y");
right_panel.pack_propagate(False)

# [ìˆ˜ì •] ë³€í™˜ê¸° í”„ë ˆì„ UI ë°°ì¹˜ ë³€ê²½
converter_frame = tk.Frame(left_panel, bg="white");
converter_frame.pack(anchor="nw", fill="x")

# From (ì…ë ¥)
from_frame, from_widgets = create_currency_frame(converter_frame, from_var);
from_frame.pack(pady=(0, 14), fill="x")
from_flag_label = from_widgets['flag'];
from_country_label = from_widgets['country']
# ìˆ«ì ì…ë ¥ì°½ pack
tk.Entry(from_widgets['right'], textvariable=amount_var, font=("ë§‘ì€ ê³ ë”•", 28, "bold"), justify="right", relief="flat",
         bg="white").pack(fill="x")
# íšŒìƒ‰ ê¸€ì”¨ pack (ì…ë ¥ì°½ ì•„ë˜)
from_amount_sub_label = from_widgets['sub_label']
from_amount_sub_label.pack(fill="x", pady=(5, 0))

# To (ê²°ê³¼)
to_frame, to_widgets = create_currency_frame(converter_frame, to_var);
to_frame.pack(pady=7, fill="x")
to_flag_label = to_widgets['flag'];
to_country_label = to_widgets['country']
# ê²°ê³¼ ìˆ«ì ë¼ë²¨ pack
to_amount_label = tk.Label(to_widgets['right'], text="", font=("ë§‘ì€ ê³ ë”•", 28, "bold"), bg="white", anchor="e");
to_amount_label.pack(fill="x")
# íšŒìƒ‰ ê¸€ì”¨ pack (ê²°ê³¼ ìˆ«ì ì•„ë˜)
to_amount_sub_label = to_widgets['sub_label']
to_amount_sub_label.pack(fill="x", pady=(5, 0))

graph_container = tk.Frame(left_panel, bg="white");
graph_container.pack(fill="both", expand=True, pady=14)
tk.Button(graph_container, text="â—€", font=("Arial", 16), command=show_prev_graph, bg="white", relief="flat").pack(
    side="left", fill="y")
graph_content_frame = tk.Frame(graph_container, bg="white");
graph_content_frame.pack(side="left", fill="both", expand=True)
tk.Button(graph_container, text="â–¶", font=("Arial", 16), command=show_next_graph, bg="white", relief="flat").pack(
    side="right", fill="y")

tk.Label(alert_panel, text="í™˜ìœ¨ ì•Œë¦¼ ì„¤ì •", font=("ë§‘ì€ ê³ ë”•", 18, "bold"), bg="white").pack(anchor="w", pady=(14, 0), padx=10)
tk.Frame(alert_panel, height=2, bg="#E0E0E0").pack(fill="x", pady=5, padx=10)
alert_input = tk.Frame(alert_panel, bg="white");
alert_input.pack(fill="x", padx=10)
tk.OptionMenu(alert_input, alert_currency_var, *graph_currency_codes).pack(side="left")
tk.OptionMenu(alert_input, alert_op_var, ">", "<").pack(side="left", padx=5)
alert_value_entry = tk.Entry(alert_input, font=("ë§‘ì€ ê³ ë”•", 14), width=10);
alert_value_entry.pack(side="left", padx=5)
tk.Button(alert_input, text="ì¶”ê°€", command=add_alert, bg="#0078D7", fg="white", relief="flat").pack(side="left", padx=10)
alert_list_frame = tk.Frame(alert_panel, bg="white");
alert_list_frame.pack(fill="both", expand=True, padx=10, pady=10)

tk.Label(right_panel, text="ì£¼ìš”êµ­ í™˜ìœ¨", font=("ë§‘ì€ ê³ ë”•", 18, "bold"), bg="white").pack(pady=14, anchor="w", padx=14)
rate_canvas = tk.Canvas(right_panel, bg="white", highlightthickness=0)
rate_scroll = tk.Scrollbar(right_panel, orient="vertical", command=rate_canvas.yview)
rate_list_scrollable_frame = tk.Frame(rate_canvas, bg="white")
rate_list_scrollable_frame.bind("<Configure>", lambda e: rate_canvas.configure(scrollregion=rate_canvas.bbox("all")))
rate_canvas.create_window((0, 0), window=rate_list_scrollable_frame, anchor="nw");
rate_canvas.configure(yscrollcommand=rate_scroll.set)
rate_canvas.pack(side="left", fill="both", expand=True);
rate_scroll.pack(side="right", fill="y")

# --- 8. í˜ì´ì§€ 2 (í™˜ìœ¨ í¬ì»¤ìŠ¤) ---
focus_page = tk.Frame(content_frame, bg="white");
focus_page.grid(row=0, column=0, sticky="nsew")

ai_summary_frame = tk.Frame(focus_page, bg="white");
ai_summary_frame.pack(side="top", fill="x", padx=28, pady=(28, 10))
tk.Label(ai_summary_frame, text="AI í™˜ìœ¨ ë™í–¥ ìš”ì•½ (í—¤ë“œë¼ì¸)", font=("ë§‘ì€ ê³ ë”•", 18, "bold"), bg="white").pack(anchor="w")
tk.Frame(ai_summary_frame, height=2, bg="#E0E0E0").pack(fill="x", pady=5)
ai_summary_label = tk.Label(ai_summary_frame, text="ë¡œë”© ì¤‘...", font=("ë§‘ì€ ê³ ë”•", 12), bg="white", justify="left",
                            wraplength=1000);
ai_summary_label.pack(fill="x")

prediction_frame = tk.Frame(focus_page, bg="#F9F9F9", highlightthickness=1, highlightbackground="#E0E0E0")
prediction_frame.pack(side="top", fill="x", padx=28, pady=10)
pred_ctrl_frame = tk.Frame(prediction_frame, bg="#F9F9F9");
pred_ctrl_frame.pack(fill="x", padx=14, pady=10)
tk.Label(pred_ctrl_frame, text="AI í™˜ìœ¨ ì˜ˆì¸¡ ë¶„ì„ & ì‹œì¥ ì‹¬ë¦¬", font=("ë§‘ì€ ê³ ë”•", 16, "bold"), bg="#F9F9F9", fg="#0078D7").pack(
    side="left")
tk.Label(pred_ctrl_frame, text="  ëŒ€ìƒ:", font=("ë§‘ì€ ê³ ë”•", 12), bg="#F9F9F9").pack(side="left", padx=(20, 5))
pred_dropdown = tk.OptionMenu(pred_ctrl_frame, prediction_currency_var, *currency_codes)
pred_dropdown.config(bg="white", relief="flat", font=("ë§‘ì€ ê³ ë”•", 11));
pred_dropdown.pack(side="left")
predict_button = tk.Button(pred_ctrl_frame, text="AI ì˜ˆì¸¡ ì‹¤í–‰", font=("ë§‘ì€ ê³ ë”•", 12, "bold"), bg="#0078D7", fg="white",
                           relief="flat",
                           command=lambda: threading.Thread(target=run_prediction_thread, daemon=True).start())
predict_button.pack(side="left", padx=14)
pred_content_frame = tk.Frame(prediction_frame, bg="white");
pred_content_frame.pack(fill="x", padx=14, pady=(0, 14))
prediction_result_text = scrolledtext.ScrolledText(pred_content_frame, height=9, width=70, font=("ë§‘ì€ ê³ ë”•", 11),
                                                   state=tk.DISABLED, bg="white", relief="flat", highlightthickness=1,
                                                   highlightbackground="#E0E0E0")
prediction_result_text.pack(side="left", fill="both", expand=True, padx=(0, 10))
gauge_canvas = tk.Canvas(pred_content_frame, width=300, height=160, bg="white", highlightthickness=0);
gauge_canvas.pack(side="right");
draw_gauge(gauge_canvas, 50)

news_list_container = tk.Frame(focus_page, bg="white");
news_list_container.pack(side="top", fill="both", expand=True, padx=28, pady=10)
total_count_label = tk.Label(news_list_container, text="ì´ 0 ê±´", font=("ë§‘ì€ ê³ ë”•", 12), bg="white", anchor="w");
total_count_label.pack(fill="x")
news_list_canvas_frame = tk.Frame(news_list_container, bg="white");
news_list_canvas_frame.pack(fill="both", expand=True)
focus_canvas = tk.Canvas(news_list_canvas_frame, bg="white", highlightthickness=0)
focus_scrollbar = tk.Scrollbar(news_list_canvas_frame, orient="vertical", command=focus_canvas.yview)
focus_scrollable_frame = tk.Frame(focus_canvas, bg="white")
focus_scrollable_frame.bind("<Configure>", lambda e: focus_canvas.configure(scrollregion=focus_canvas.bbox("all")))
focus_canvas.create_window((0, 0), window=focus_scrollable_frame, anchor="nw");
focus_canvas.configure(yscrollcommand=focus_scrollbar.set)
focus_canvas.pack(side="left", fill="both", expand=True);
focus_scrollbar.pack(side="right", fill="y")
news_nav_frame = tk.Frame(focus_page, bg="white");
news_nav_frame.pack(side="bottom", fill="x", padx=28, pady=20)
prev_news_button = tk.Button(news_nav_frame, text="â—€ ì´ì „", command=show_prev_news_page, state=tk.DISABLED, bg="white",
                             relief="flat");
prev_news_button.pack(side="left")
page_info_label = tk.Label(news_nav_frame, text="1 / 1", bg="white");
page_info_label.pack(side="left", expand=True)
next_news_button = tk.Button(news_nav_frame, text="ë‹¤ìŒ â–¶", command=show_next_news_page, state=tk.DISABLED, bg="white",
                             relief="flat");
next_news_button.pack(side="right")

# --- 9. í˜ì´ì§€ 3 (ìˆ˜ìˆ˜ë£Œ ë¹„êµ) ---
fee_page = tk.Frame(content_frame, bg="white");
fee_page.grid(row=0, column=0, sticky="nsew")

fee_header = tk.Frame(fee_page, bg="white");
fee_header.pack(fill="x", padx=28, pady=28)
tk.Label(fee_header, text="ì‹¤ì† í™˜ì „ ìˆ˜ìˆ˜ë£Œ ë¹„êµê¸°", font=("ë§‘ì€ ê³ ë”•", 22, "bold"), bg="white", fg="#0078D7").pack(anchor="w")
tk.Label(fee_header, text="ì›í™”(KRW)ë¡œ í™˜ì „ ì‹œ, ì–´ë””ì„œ í™˜ì „í•´ì•¼ ê°€ì¥ ë§ì€ ì™¸í™”ë¥¼ ë°›ì„ê¹Œìš”?", font=("ë§‘ì€ ê³ ë”•", 12), bg="white", fg="gray").pack(
    anchor="w")

fee_input_frame = tk.Frame(fee_page, bg="#F9F9F9", padx=20, pady=20, highlightbackground="#E0E0E0",
                           highlightthickness=1)
fee_input_frame.pack(fill="x", padx=28, pady=10)
tk.Label(fee_input_frame, text="í™˜ì „í•  ê¸ˆì•¡ (KRW):", font=("ë§‘ì€ ê³ ë”•", 12, "bold"), bg="#F9F9F9").pack(side="left")
fee_amount_entry = tk.Entry(fee_input_frame, font=("ë§‘ì€ ê³ ë”•", 12), width=12);
fee_amount_entry.pack(side="left", padx=10)
fee_amount_entry.insert(0, "1000000")
tk.Label(fee_input_frame, text="â†’ ë°›ì„ í†µí™”:", font=("ë§‘ì€ ê³ ë”•", 12), bg="#F9F9F9").pack(side="left", padx=10)
tk.OptionMenu(fee_input_frame, fee_currency_var, "USD", "JPY", "EUR").pack(side="left")
tk.Button(fee_input_frame, text="ìµœì €ê°€ ë¹„êµ & AI ë¶„ì„", font=("ë§‘ì€ ê³ ë”•", 12, "bold"), bg="#0078D7", fg="white", relief="flat",
          command=calculate_fees_and_recommend).pack(side="right")

fee_tree_frame = tk.Frame(fee_page, bg="white");
fee_tree_frame.pack(fill="x", padx=28, pady=10)
columns = ("method", "rate", "total", "note")
fee_tree = ttk.Treeview(fee_tree_frame, columns=columns, show="headings", height=4)
fee_tree.heading("method", text="í™˜ì „ ë°©ë²•");
fee_tree.heading("rate", text="ì ìš© í™˜ìœ¨ (ì‚´ ë•Œ)");
fee_tree.heading("total", text="ì‹¤ì œ ìˆ˜ë ¹ì•¡");
fee_tree.heading("note", text="ë¹„ê³ ")
fee_tree.column("method", width=200);
fee_tree.column("rate", width=120, anchor="e");
fee_tree.column("total", width=150, anchor="e");
fee_tree.column("note", width=250)
fee_tree.pack(fill="x")

fee_ai_frame = tk.Frame(fee_page, bg="white");
fee_ai_frame.pack(fill="both", expand=True, padx=28, pady=20)
tk.Label(fee_ai_frame, text="Gemini AIì˜ ê¸ˆìœµ ì¡°ì–¸", font=("ë§‘ì€ ê³ ë”•", 14, "bold"), bg="white").pack(anchor="w", pady=(0, 5))
fee_result_text = scrolledtext.ScrolledText(fee_ai_frame, height=18, font=("ë§‘ì€ ê³ ë”•", 11), bg="#F0F8FF", relief="flat")
fee_result_text.pack(fill="both", expand=True)
fee_result_text.insert(tk.END, "ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”. ë„¤ì´ë²„ ê¸ˆìœµ ì‹¤ì‹œê°„ í™˜ìœ¨ì„ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.")
fee_result_text.config(state=tk.DISABLED)

# --- 9. ë©”ë‰´ & ì‹œì‘ ---
menu_items = {}


def create_menu_btn(name, text, page):
    f = tk.Frame(sidebar_frame, bg="#F5F5F5");
    f.pack(pady=7, padx=14, fill="x")
    b = tk.Button(f, text=text, font=("ë§‘ì€ ê³ ë”•", 16, "bold"), relief="flat", bg="#F5F5F5",
                  command=lambda: show_page(name));
    b.pack()
    u = tk.Frame(f, height=2, bg="black");
    menu_items[name] = {'button': b, 'underline': u, 'page': page}


create_menu_btn('exchange', 'í™˜ìœ¨', exchange_page);
create_menu_btn('focus', 'í™˜ìœ¨ í¬ì»¤ìŠ¤', focus_page)
create_menu_btn('fee', 'ìˆ˜ìˆ˜ë£Œ ë¹„êµ', fee_page)

amount_var.trace("w", update_conversion_display);
from_var.trace("w", update_all_displays);
to_var.trace("w", update_all_displays)
show_page("exchange");
periodic_update();
window.mainloop()
